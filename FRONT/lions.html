<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT√ÅVIO DE QUADROS - LIONS</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS (via CDN para prototipagem r√°pida) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config for Dynamic Themes -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: {
                            50: 'var(--color-primary-50)',
                            100: 'var(--color-primary-100)',
                            200: 'var(--color-primary-200)',
                            300: 'var(--color-primary-300)',
                            400: 'var(--color-primary-400)',
                            500: 'var(--color-primary-500)',
                            600: 'var(--color-primary-600)',
                            700: 'var(--color-primary-700)',
                            800: 'var(--color-primary-800)',
                            900: 'var(--color-primary-900)',
                            950: 'var(--color-primary-950)',
                        },
                        shop: {
                            50: 'var(--color-shop-50)',
                            100: 'var(--color-shop-100)',
                            200: 'var(--color-shop-200)',
                            300: 'var(--color-shop-300)',
                            400: 'var(--color-shop-400)',
                            500: 'var(--color-shop-500)',
                            600: 'var(--color-shop-600)',
                            700: 'var(--color-shop-700)',
                            800: 'var(--color-shop-800)',
                            900: 'var(--color-shop-900)',
                            950: 'var(--color-shop-950)',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Configura√ß√£o de fontes e estilos base -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Default Theme (Indigo) */
            --color-primary-50: #eef2ff;
            --color-primary-100: #e0e7ff;
            --color-primary-200: #c7d2fe;
            --color-primary-300: #a5b4fc;
            --color-primary-400: #818cf8;
            --color-primary-500: #6366f1;
            --color-primary-600: #4f46e5;
            --color-primary-700: #4338ca;
            --color-primary-800: #3730a3;
            --color-primary-900: #312e81;
            --color-primary-950: #1e1b4b;

            /* Shop Mode Colors (Green Default) */
            --color-shop-50: #f0fdf4;
            --color-shop-100: #dcfce7;
            --color-shop-200: #bbf7d0;
            --color-shop-300: #86efac;
            --color-shop-400: #4ade80;
            --color-shop-500: #22c55e;
            --color-shop-600: #16a34a;
            --color-shop-700: #15803d;
            --color-shop-800: #166534;
            --color-shop-900: #14532d;
            --color-shop-950: #052e16;
        }

        /* Theme Classes */
        .theme-emerald {
            --color-primary-50: #ecfdf5;
            --color-primary-100: #d1fae5;
            --color-primary-200: #a7f3d0;
            --color-primary-300: #6ee7b7;
            --color-primary-400: #34d399;
            --color-primary-500: #10b981;
            --color-primary-600: #059669;
            --color-primary-700: #047857;
            --color-primary-800: #065f46;
            --color-primary-900: #064e3b;
            --color-primary-950: #022c22;
        }

        .theme-rose {
            --color-primary-50: #fff1f2;
            --color-primary-100: #ffe4e6;
            --color-primary-200: #fecdd3;
            --color-primary-300: #fda4af;
            --color-primary-400: #fb7185;
            --color-primary-500: #f43f5e;
            --color-primary-600: #e11d48;
            --color-primary-700: #be123c;
            --color-primary-800: #9f1239;
            --color-primary-900: #881337;
            --color-primary-950: #4c0519;
        }

        .theme-amber {
            --color-primary-50: #fffbeb;
            --color-primary-100: #fef3c7;
            --color-primary-200: #fde68a;
            --color-primary-300: #fcd34d;
            --color-primary-400: #fbbf24;
            --color-primary-500: #f59e0b;
            --color-primary-600: #d97706;
            --color-primary-700: #b45309;
            --color-primary-800: #92400e;
            --color-primary-900: #78350f;
            --color-primary-950: #451a03;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Anima√ß√µes sutis */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos de Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Hide number input spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-500 min-h-screen" id="main-body">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-50 transition-colors duration-500">
        <div class="w-full max-w-md px-6 flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-6"></div>
            <h2 class="text-xl font-bold text-slate-800 mb-2" id="loading-title">Conectando ao Servidor...</h2>
            <p class="text-slate-500 text-sm text-center mb-8" id="loading-text">A API est√° iniciando. Isso pode levar um tempo se o servidor estiver üò¥üí§üí§üí§.</p>
            
            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden" id="loading-bar-bg">
                <div id="loading-progress" class="bg-indigo-600 h-2.5 rounded-full w-0" style="transition: width 180s ease-out;"></div>
            </div>
        </div>
    </div>

    <!-- Styles for Loading Overlay Dark Mode -->
    <style>
        @media (prefers-color-scheme: dark) {
            #loading-overlay { background-color: #0f172a; } /* slate-900 */
            #loading-title { color: #f8fafc; } /* slate-50 */
            #loading-text { color: #94a3b8; } /* slate-400 */
            #loading-bar-bg { background-color: #334155; } /* slate-700 */
        }
    </style>

    <!-- Navbar Superior -->
    <header id="header" class="px-6 py-4 flex justify-between items-center border-b bg-white border-slate-200 shadow-sm sticky top-0 z-10 transition-colors duration-500 overflow-x-auto no-scrollbar">
        <div class="flex items-center gap-2 flex-shrink-0">
            <button id="back-to-hub-btn" class="hidden p-2 rounded-lg text-slate-500 hover:bg-slate-100 transition-colors mr-2">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <div id="logo-icon-bg" class="p-2 rounded-lg bg-indigo-100 text-indigo-700 transition-colors duration-500">
                <i data-lucide="layout-dashboard" id="logo-icon"></i>
            </div>
            <div class="min-w-0">
                <h1 class="font-bold text-lg leading-tight truncate max-w-[200px] sm:max-w-none">LionsDash</h1>
                <p id="mode-text" class="text-xs text-slate-500 truncate">Dashboard de Planeamento</p>
            </div>
        </div>

        <div class="flex items-center gap-3 flex-shrink-0">
            <button id="settings-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>

            <button id="recipes-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" title="Livro de Receitas">
                <i data-lucide="book-open" class="w-5 h-5"></i>
            </button>

            <button id="tutorial-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" title="Como usar">
                <i data-lucide="help-circle" class="w-5 h-5"></i>
            </button>

            <button id="theme-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>

            <button id="toggle-mode-btn" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium text-sm transition-all shadow-md bg-indigo-600 hover:bg-indigo-700 text-white">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                <span>Ir √†s Compras</span>
            </button>
            
            <button id="share-btn" class="hidden p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" title="Compartilhar no WhatsApp">
                <i data-lucide="share-2" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Offline Warning -->
    <div id="offline-warning" class="hidden bg-amber-50 border-b border-amber-100 px-6 py-3 flex items-center justify-between transition-colors duration-500">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-amber-100 text-amber-600 rounded-lg">
                <i data-lucide="wifi-off" class="w-5 h-5"></i>
            </div>
            <div>
                <p class="text-sm font-bold text-amber-800">Modo Offline</p>
                <p class="text-xs text-amber-600">Voc√™ est√° desconectado. Algumas funcionalidades podem estar limitadas.</p>
            </div>
        </div>
        <button onclick="location.reload()" class="text-xs font-medium text-amber-700 hover:text-amber-900 underline">
            Tentar Reconectar
        </button>
    </div>

    <!-- HUB SECTION -->
    <section id="hub-section" class="max-w-7xl mx-auto p-4 md:p-6 fade-in hidden">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 id="hub-title" class="text-2xl font-bold text-slate-800 transition-colors">Meus Or√ßamentos</h2>
                <p id="hub-subtitle" class="text-slate-500 text-sm transition-colors">Gerencie suas listas de compras por local</p>
            </div>
            <button id="open-new-budget-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Novo Or√ßamento</span>
            </button>
        </div>

        <div id="hub-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards will be injected here -->
        </div>
    </section>

    <main id="dashboard-section" class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 hidden">
        
        <!-- COLUNA ESQUERDA: Sidebar (Analytics) -->
        <aside id="sidebar" class="lg:col-span-4 space-y-6 fade-in">
            <!-- Card de Or√ßamento -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 transition-colors duration-500" id="budget-card">
                <div class="flex justify-between items-end mb-4">
                    <div class="min-w-0 flex-1 mr-4">
                        <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider truncate" id="budget-title-display">Or√ßamento Semanal</h2>
                        <div class="text-3xl font-bold text-slate-800 mt-1 transition-colors duration-500" id="budget-display">
                            R$ 0.00 <span class="text-base text-slate-400 font-normal">/ R$ <span id="budget-limit-display">500</span></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="budget-settings-btn" class="p-2 rounded-lg transition-colors">
                            <i data-lucide="settings-2" class="w-5 h-5"></i>
                        </button>
                        <div class="p-2 bg-green-100 text-green-700 rounded-lg">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                    </div>
                </div>

                <!-- Barra de Progresso -->
                <div id="progress-bar-container" class="w-full bg-slate-100 rounded-full h-3 mb-2 overflow-hidden transition-colors duration-500">
                    <div id="progress-bar" class="h-3 rounded-full bg-green-500 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-xs text-slate-500 flex justify-between">
                    <span id="estimated-total">Est: R$ 0.00</span>
                    <span id="remaining-budget">Resta: R$ 500.00</span>
                </p>
            </div>

            <!-- Card de Menu (Removido) -->
            <!-- <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 transition-colors duration-500" id="menu-card"> ... </div> -->
        </aside>

        <!-- COLUNA DIREITA: Lista -->
        <section id="main-section" class="lg:col-span-8 transition-all duration-500">
            
            <!-- Action Bar (Search) -->
            <div id="action-bar" class="mb-4 fade-in transition-colors duration-500">
                <div class="relative w-full group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Buscar na lista..." class="w-full h-12 pl-10 bg-white border border-slate-100 focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 rounded-xl text-sm transition-all font-medium shadow-sm" autocomplete="off">
                </div>
            </div>

            <!-- Controles da Lista (Add + Sort) -->
            <div class="flex justify-between items-center mb-6 px-1">
                <button id="open-add-modal-btn" class="h-10 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center justify-center gap-2 transition-all shadow-md shadow-indigo-200 hover:shadow-indigo-300 hover:scale-105 active:scale-95">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="font-medium text-sm">Adicionar Item</span>
                </button>

                <div class="relative w-48" id="sort-dropdown-container">
                    <button id="sort-dropdown-btn" onclick="toggleSortDropdown()" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 text-sm text-slate-600 flex items-center justify-between transition-all">
                        <span id="selected-sort-display" class="truncate">Ordem Padr√£o</span>
                        <i data-lucide="arrow-up-down" class="w-4 h-4 text-slate-400"></i>
                    </button>
                    
                    <div id="sort-dropdown-menu" class="hidden absolute top-full right-0 w-full mt-1 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20">
                        <div onclick="selectSort('default', 'Ordem Padr√£o')" class="px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors">Ordem Padr√£o</div>
                        <div onclick="selectSort('price-desc', 'Maior Pre√ßo')" class="px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors">Maior Pre√ßo</div>
                        <div onclick="selectSort('price-asc', 'Menor Pre√ßo')" class="px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors">Menor Pre√ßo</div>
                        <div onclick="selectSort('name-asc', 'Nome (A-Z)')" class="px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors">Nome (A-Z)</div>
                    </div>
                </div>
            </div>

            <!-- Container da Lista -->
            <div id="items-container" class="space-y-6 pb-20">
                <!-- Itens ser√£o injetados aqui via JS -->
            </div>
        </section>
    </main>

    <!-- Footer Flutuante (Modo Loja) -->
    <div id="shop-footer" class="fixed bottom-0 left-0 w-full bg-gray-900 border-t border-gray-800 p-4 pb-8 z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.5)] transform translate-y-full transition-transform duration-300 hidden">
        <div class="max-w-2xl mx-auto flex justify-between items-center text-white">
            <div>
                <p class="text-xs text-gray-400 uppercase">Carrinho</p>
                <p class="text-2xl font-bold font-mono text-green-400" id="footer-total">R$ 0.00</p>
            </div>
            
            <button id="finish-shop-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full font-bold shadow-lg transition-colors flex items-center gap-2">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Finalizar</span>
            </button>

            <div class="text-right">
                <p class="text-xs text-gray-400 uppercase">Faltam</p>
                <p class="text-xl font-bold"><span id="footer-remaining-count">0</span></p>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="delete-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="delete-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="delete-modal-title" class="text-lg font-bold text-slate-800 mb-2 transition-colors">Remover Item?</h3>
            <p id="delete-modal-text" class="text-slate-500 mb-6 transition-colors">Tem certeza que deseja remover este item da lista?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors">Remover</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="edit-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="edit-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="edit-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Editar Item</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Nome</label>
                    <input type="text" id="edit-name-input" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
                
                <div class="relative" id="edit-category-dropdown-container">
                    <label class="block text-xs font-medium text-slate-500 mb-1">Categoria</label>
                    <button id="edit-category-dropdown-btn" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-3 text-sm text-slate-600 flex items-center justify-between transition-all font-medium">
                        <span id="edit-selected-category-display" class="truncate">Geral</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 flex-shrink-0 ml-1"></i>
                    </button>
                    <div id="edit-category-dropdown-menu" class="hidden absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto">
                        <!-- Options injected via JS -->
                    </div>
                    <input type="hidden" id="edit-category-select" value="Geral">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Quantidade</label>
                    <div class="flex gap-2">
                        <input type="number" id="edit-quantity-input" min="1" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                        
                        <div class="relative w-24" id="edit-unit-dropdown-container">
                            <button id="edit-unit-dropdown-btn" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-2 text-sm text-slate-600 flex items-center justify-between transition-all font-medium">
                                <span id="edit-selected-unit-display" class="truncate w-full text-center">un</span>
                                <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400 flex-shrink-0 absolute right-2 pointer-events-none"></i>
                            </button>
                            <div id="edit-unit-dropdown-menu" class="hidden absolute top-full right-0 w-24 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto">
                                <!-- Options injected via JS -->
                            </div>
                            <input type="hidden" id="edit-unit-input" value="un">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Pre√ßo (Opcional)</label>
                    <input type="number" id="edit-price-input" step="0.01" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-edit-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="save-edit-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Nova Categoria -->
    <div id="add-category-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="add-category-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="add-category-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Nova Categoria</h3>
            <input type="text" id="new-category-input" placeholder="Nome da categoria" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm mb-6 transition-all">
            <div class="flex justify-end gap-3">
                <button id="cancel-category-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="confirm-category-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Finalizar Compra -->
    <div id="finish-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="finish-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="finish-modal-title" class="text-lg font-bold text-slate-800 mb-2 transition-colors">Finalizar Compra?</h3>
            <p id="finish-modal-text" class="text-slate-500 mb-6 transition-colors">Isso remover√° todos os itens marcados da sua lista. Deseja continuar?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-finish-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="confirm-finish-btn" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition-colors">Finalizar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes do Or√ßamento -->
    <div id="budget-settings-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl" id="budget-settings-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Configurar Or√ßamento</h3>
                <button id="close-budget-settings-modal" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label id="budget-title-label" class="block text-sm font-medium text-slate-600 mb-1 transition-colors">Nome do Or√ßamento</label>
                    <input type="text" id="budget-title-input" class="w-full px-4 h-10 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="Ex: Or√ßamento Semanal">
                </div>
                
                <div>
                    <label id="budget-limit-label" class="block text-sm font-medium text-slate-600 mb-1 transition-colors">Limite do Or√ßamento</label>
                    <div class="relative">
                        <span id="budget-currency-symbol" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 transition-colors">R$</span>
                        <input type="number" id="budget-limit-input" class="w-full pl-10 pr-4 h-10 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" placeholder="500">
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button id="cancel-budget-settings" class="flex-1 px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors">
                    Cancelar
                </button>
                <button id="save-budget-settings" class="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition-all">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes Gerais -->
    <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="settings-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="settings-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Configura√ß√µes</h3>
            
            <div class="space-y-4 mb-6">
                <!-- App Name -->
                <div>
                    <label id="label-app-name" class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome do App</label>
                    <input type="text" id="settings-app-name" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>

                <!-- Theme Switcher -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tema de Cores</label>
                    <div class="flex gap-3">
                        <button onclick="setTheme('indigo')" class="w-8 h-8 rounded-full hover:ring-2 ring-offset-2 transition-all" style="background-color: #6366f1; --tw-ring-color: #a5b4fc;" title="Indigo (Padr√£o)"></button>
                        <button onclick="setTheme('emerald')" class="w-8 h-8 rounded-full bg-emerald-500 hover:ring-2 ring-offset-2 ring-emerald-300 transition-all" title="Emerald (Verde)"></button>
                        <button onclick="setTheme('rose')" class="w-8 h-8 rounded-full bg-rose-500 hover:ring-2 ring-offset-2 ring-rose-300 transition-all" title="Rose (Rosa)"></button>
                        <button onclick="setTheme('amber')" class="w-8 h-8 rounded-full bg-amber-500 hover:ring-2 ring-offset-2 ring-amber-300 transition-all" title="Amber (Laranja)"></button>
                    </div>
                </div>

                <!-- Round Values Toggle -->
                <div class="flex items-center justify-between cursor-pointer" id="settings-round-container">
                    <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-round-label">Arredondar Valores</span>
                    <div id="settings-round-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                        <div id="settings-round-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                    </div>
                </div>

                <!-- Suggestions Toggle -->
                <div class="flex items-center justify-between cursor-pointer" id="settings-suggestions-container">
                    <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-suggestions-label">Sugest√µes de Pre√ßo</span>
                    <div id="settings-suggestions-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                        <div id="settings-suggestions-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                    </div>
                </div>

                <!-- Confirmations Section -->
                <div class="pt-4 border-t border-slate-100" id="settings-confirmations-divider">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3" id="settings-confirmations-title">Confirma√ß√µes</h4>
                    
                    <div class="space-y-3">
                        <!-- Confirm Delete Budget -->
                        <div class="flex items-center justify-between cursor-pointer" id="settings-confirm-budget-container">
                            <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-confirm-budget-label">Excluir Or√ßamento</span>
                            <div id="settings-confirm-budget-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                                <div id="settings-confirm-budget-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                            </div>
                        </div>

                        <!-- Confirm Delete Item -->
                        <div class="flex items-center justify-between cursor-pointer" id="settings-confirm-item-container">
                            <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-confirm-item-label">Excluir Item/Categoria</span>
                            <div id="settings-confirm-item-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                                <div id="settings-confirm-item-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                            </div>
                        </div>

                        <!-- Confirm Delete Suggestion -->
                        <div class="flex items-center justify-between cursor-pointer" id="settings-confirm-suggestion-container">
                            <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-confirm-suggestion-label">Excluir Sugest√£o</span>
                            <div id="settings-confirm-suggestion-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                                <div id="settings-confirm-suggestion-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                            </div>
                        </div>

                        <!-- Confirm Finish Shop -->
                        <div class="flex items-center justify-between cursor-pointer" id="settings-confirm-finish-container">
                            <span class="text-sm font-medium text-slate-600 transition-colors" id="settings-confirm-finish-label">Finalizar Compra</span>
                            <div id="settings-confirm-finish-toggle" class="w-12 h-6 rounded-full bg-slate-200 relative transition-colors duration-300">
                                <div id="settings-confirm-finish-knob" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-settings-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="save-settings-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Salvar</button>
            </div>

            <!-- GitHub & Version Info -->
            <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                <a href="https://github.com/Ort4vi0/ListaDeCompras-LIONS" target="_blank" class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-indigo-500 transition-colors mb-1">
                    <i data-lucide="github" class="w-3 h-3"></i>
                    <span>Ort4vi0/ListaDeCompras-LIONS</span>
                </a>
                <p class="text-[10px] text-slate-300 font-mono">v1.0.5</p>
            </div>
        </div>
    </div>

    <!-- Modal de Excluir Sugest√£o -->
    <div id="delete-suggestion-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="delete-suggestion-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="delete-suggestion-modal-title" class="text-lg font-bold text-slate-800 mb-2 transition-colors">Excluir Sugest√£o?</h3>
            <p id="delete-suggestion-modal-text" class="text-slate-500 mb-6 transition-colors">Tem certeza que deseja remover este produto das sugest√µes?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-suggestion-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="confirm-delete-suggestion-btn" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Novo Or√ßamento (HUB) -->
    <div id="new-budget-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="new-budget-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="new-budget-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Criar Novo Or√ßamento</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label id="new-budget-name-label" class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome (Ex: Mercado Semanal)</label>
                    <input type="text" id="new-budget-name" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
                <div>
                    <label id="new-budget-limit-label" class="block text-xs font-bold text-slate-400 uppercase mb-1">Limite (R$)</label>
                    <input type="number" id="new-budget-limit" placeholder="500.00" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-new-budget-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="create-budget-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Or√ßamento (HUB) -->
    <div id="edit-hub-budget-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="edit-hub-budget-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="edit-hub-budget-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Editar Or√ßamento</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label id="edit-hub-budget-name-label" class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome</label>
                    <input type="text" id="edit-hub-budget-name" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
                <div>
                    <label id="edit-hub-budget-limit-label" class="block text-xs font-bold text-slate-400 uppercase mb-1">Limite (R$)</label>
                    <input type="number" id="edit-hub-budget-limit" class="w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-edit-hub-budget-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="save-edit-hub-budget-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Excluir Or√ßamento (HUB) -->
    <div id="delete-budget-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="delete-budget-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="delete-budget-modal-title" class="text-lg font-bold text-slate-800 mb-2 transition-colors">Excluir Or√ßamento?</h3>
            <p id="delete-budget-modal-text" class="text-slate-500 mb-6 transition-colors">Tem certeza que deseja excluir este or√ßamento? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-budget-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="confirm-delete-budget-btn" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Tutorial -->
    <div id="tutorial-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="tutorial-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="tutorial-modal-title" class="text-xl font-bold text-slate-800 transition-colors">Como usar o LionsDash</h3>
                <button id="close-tutorial-btn" class="p-1 rounded-lg hover:bg-slate-100 text-slate-400 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="tutorial-modal-text" class="space-y-4 text-slate-600 text-sm transition-colors">
                <div class="flex gap-3">
                    <div class="p-2 bg-indigo-100 text-indigo-600 rounded-lg h-fit"><i data-lucide="layout-grid" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Or√ßamentos (Hub)</h4>
                        <p>Crie listas separadas para diferentes ocasi√µes (Mercado Semanal, Farm√°cia, Churrasco). Cada or√ßamento tem seus pr√≥prios itens e limite de gastos.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg h-fit"><i data-lucide="plus-circle" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Adicionar Itens</h4>
                        <p>Digite o nome, pre√ßo e quantidade. Voc√™ pode selecionar a unidade de medida (kg, g, L, etc) ao lado da quantidade.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="p-2 bg-blue-100 text-blue-600 rounded-lg h-fit"><i data-lucide="arrow-up-down" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Organizar Corredores</h4>
                        <p>Use as setas <i data-lucide="arrow-up" class="w-3 h-3 inline"></i> e <i data-lucide="arrow-down" class="w-3 h-3 inline"></i> ao lado do nome da categoria na lista para reorden√°-las conforme a disposi√ß√£o do seu supermercado.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg h-fit"><i data-lucide="share-2" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Compartilhar</h4>
                        <p>Clique no √≠cone de compartilhar no topo para enviar sua lista pendente via WhatsApp para algu√©m.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="p-2 bg-amber-100 text-amber-600 rounded-lg h-fit"><i data-lucide="shopping-cart" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Modo Loja</h4>
                        <p>Ao chegar no mercado, clique em "Ir √†s Compras". A interface fica mais limpa para voc√™ focar em marcar os itens que colocar no carrinho.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-lg h-fit"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1 tutorial-heading">Finalizar</h4>
                        <p>Ao terminar, clique em "Finalizar Compra". Os itens marcados ser√£o removidos da lista, mantendo apenas o que voc√™ n√£o comprou para a pr√≥xima vez.</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                <button id="ok-tutorial-btn" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Entendi</button>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Item -->
    <div id="add-item-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="add-item-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500">
            <h3 id="add-item-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Adicionar Item</h3>
            
            <div class="space-y-4 mb-6">
                <!-- Name Input Group -->
                <div class="relative w-full group">
                    <label class="block text-xs font-medium text-slate-500 mb-1">Nome</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        </div>
                        <input type="text" id="input-name" placeholder="Ex: Leite" class="w-full h-10 pl-9 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm transition-all font-medium" autocomplete="off">
                    </div>
                    <!-- Custom Suggestions Dropdown -->
                    <div id="suggestions-dropdown" class="hidden absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-30 max-h-60 overflow-y-auto">
                        <!-- Suggestions injected via JS -->
                    </div>
                </div>

                <!-- Category -->
                <div class="relative" id="category-dropdown-container">
                    <label class="block text-xs font-medium text-slate-500 mb-1">Categoria</label>
                    <button id="category-dropdown-btn" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-3 text-sm text-slate-600 flex items-center justify-between transition-all font-medium">
                        <span id="selected-category-display" class="truncate">Geral</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 flex-shrink-0 ml-1"></i>
                    </button>
                    <div id="category-dropdown-menu" class="hidden absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto">
                        <!-- Options injected via JS -->
                    </div>
                    <input type="hidden" id="input-category" value="Geral">
                </div>

                <!-- Quantity & Unit -->
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Quantidade</label>
                    <div class="flex gap-2">
                        <input type="number" id="input-quantity" placeholder="1" min="1" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-3 text-sm font-medium transition-all">
                        <div class="relative w-24" id="unit-dropdown-container">
                            <button id="unit-dropdown-btn" class="w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-2 text-sm text-slate-600 flex items-center justify-between transition-all font-medium">
                                <span id="selected-unit-display" class="truncate w-full text-center">un</span>
                                <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400 flex-shrink-0 absolute right-2 pointer-events-none"></i>
                            </button>
                            <div id="unit-dropdown-menu" class="hidden absolute top-full right-0 w-24 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto">
                                <!-- Options injected via JS -->
                            </div>
                            <input type="hidden" id="input-unit" value="un">
                        </div>
                    </div>
                </div>

                <!-- Price -->
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Pre√ßo (Opcional)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-medium">R$</span>
                        <input type="number" id="input-price" placeholder="0.00" class="w-full h-10 pl-8 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm font-medium transition-all">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-add-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="add-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Adicionar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Receitas (Lista) -->
    <div id="recipes-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="recipes-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="recipes-modal-title" class="text-lg font-bold text-slate-800 transition-colors">Livro de Receitas</h3>
                <button id="close-recipes-modal-btn" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="recipes-list" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                <!-- Recipes injected via JS -->
                <div class="text-center py-8 text-slate-400">
                    <i data-lucide="chef-hat" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    <p>Nenhuma receita cadastrada.</p>
                </div>
            </div>

            <button id="open-new-recipe-modal-btn" class="w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors flex items-center justify-center gap-2">
                <i data-lucide="plus" class="w-5 h-5"></i>
                Nova Receita
            </button>
        </div>
    </div>

    <!-- Modal de Nova Receita -->
    <div id="new-recipe-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden fade-in">
        <div id="new-recipe-modal-content" class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[90vh] overflow-y-auto">
            <h3 id="new-recipe-modal-title" class="text-lg font-bold text-slate-800 mb-4 transition-colors">Nova Receita</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Nome do Prato</label>
                    <input type="text" id="recipe-name-input" placeholder="Ex: Strogonoff" class="w-full h-10 px-4 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm transition-all font-medium">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-2">Ingredientes</label>
                    <div id="recipe-ingredients-list" class="space-y-2 mb-2">
                        <!-- Ingredient rows -->
                    </div>
                    <button id="add-ingredient-btn" class="text-sm text-indigo-600 font-medium hover:text-indigo-700 flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i> Adicionar Ingrediente
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-recipe-btn" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors">Cancelar</button>
                <button id="save-recipe-btn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">Salvar Receita</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script src="config.js"></script>
    <script>
        // --- CONFIGURA√á√ÉO E ESTADO ---
        const state = {
            view: 'hub', // 'hub' | 'dashboard'
            budgets: [],
            activeBudgetId: null,
            editingItemId: null,

            // Global Settings
            shopMode: false,
            theme: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_THEME : 'dark',
            appName: typeof CONFIG !== 'undefined' ? CONFIG.APP_NAME : 'LionsDash',
            appSlogan: typeof CONFIG !== 'undefined' ? CONFIG.APP_SLOGAN : 'Dashboard',
            roundValues: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_ROUND_VALUES : false,
            enableSuggestions: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_ENABLE_SUGGESTIONS : true,
            
            // Confirmation Settings
            confirmDeleteBudget: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_CONFIRMATIONS.deleteBudget : true,
            confirmDeleteItem: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_CONFIRMATIONS.deleteItem : true,
            confirmDeleteSuggestion: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_CONFIRMATIONS.deleteSuggestion : true,
            confirmFinishShop: typeof CONFIG !== 'undefined' ? CONFIG.DEFAULT_CONFIRMATIONS.finishShop : true,

            // Active Budget Data (Loaded from budgets array)
            budgetLimit: 500,
            budgetTitle: 'Or√ßamento Semanal',
            items: [],
            categories: ['Geral'],
            products: [], // Cache for suggestions
            searchTerm: '' // New search term state
        };

        // --- CAMADA DE SERVI√áO DE API (REAL) ---
        const API_BASE = typeof CONFIG !== 'undefined' ? CONFIG.API_BASE_URL : 'http://localhost:3000/api';
        const API_URL = `${API_BASE}/budgets`;
        const PRODUCTS_URL = `${API_BASE}/products`;

        const apiService = {
            // Products
            async fetchProducts() {
                try {
                    const res = await fetch(PRODUCTS_URL);
                    if (!res.ok) return [];
                    return await res.json();
                } catch (e) {
                    return [];
                }
            },

            async createProduct(product) {
                try {
                    const res = await fetch(PRODUCTS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                    return await res.json();
                } catch (e) {
                    console.error(e);
                }
            },

            async deleteProduct(id) {
                try {
                    await fetch(`${PRODUCTS_URL}/${id}`, {
                        method: 'DELETE'
                    });
                } catch (e) {
                    console.error(e);
                }
            },

            // Budgets
            async fetchBudgets() {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return await res.json();
            },

            async createBudget(budget) {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(budget)
                });
                return await res.json();
            },

            async updateBudget(id, data) {
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            },

            async deleteBudget(id) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                return true;
            },

            async saveBudgets(budgets) {
                // Deprecated: Persistence is handled per-action.
            },

            // Items
            async fetchItems() {
                if (!state.activeBudgetId) return [];
                const res = await fetch(`${API_URL}/${state.activeBudgetId}`);
                const budget = await res.json();
                return budget.items || [];
            },

            async addItem(item) {
                if (!state.activeBudgetId) return item;
                const res = await fetch(`${API_URL}/${state.activeBudgetId}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
                const updatedBudget = await res.json();
                return updatedBudget.items[updatedBudget.items.length - 1];
            },

            async deleteItem(id) {
                if (!state.activeBudgetId) return;
                await fetch(`${API_URL}/${state.activeBudgetId}/items/${id}`, {
                    method: 'DELETE'
                });
                return true;
            },

            async toggleItem(id, isChecked) {
                if (!state.activeBudgetId) return;
                await fetch(`${API_URL}/${state.activeBudgetId}/items/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checked: isChecked })
                });
            },

            async updateItem(id, item) {
                if (!state.activeBudgetId) return;
                await fetch(`${API_URL}/${state.activeBudgetId}/items/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
            },

            async deleteCategory(budgetId, categoryName) {
                if (!budgetId) return;
                await fetch(`${API_URL}/${budgetId}/categories/${encodeURIComponent(categoryName)}`, {
                    method: 'DELETE'
                });
            }
        };

        // --- ELEMENTOS DO DOM ---
        const dom = {
            body: document.getElementById('main-body'),
            header: document.getElementById('header'),
            backToHubBtn: document.getElementById('back-to-hub-btn'), // NEW
            logoIcon: document.getElementById('logo-icon'),
            logoIconBg: document.getElementById('logo-icon-bg'),
            modeText: document.getElementById('mode-text'),
            toggleBtn: document.getElementById('toggle-mode-btn'),
            themeBtn: document.getElementById('theme-toggle-btn'),
            
            // Sections
            hubSection: document.getElementById('hub-section'), // NEW
            hubGrid: document.getElementById('hub-grid'), // NEW
            dashboardSection: document.getElementById('dashboard-section'), // Renamed from main-section wrapper
            
            sidebar: document.getElementById('sidebar'),
            mainSection: document.getElementById('main-section'),
            addForm: document.getElementById('add-form'),
            itemsContainer: document.getElementById('items-container'),
            shopFooter: document.getElementById('shop-footer'),
            // Inputs
            inputName: document.getElementById('input-name'),
            inputCategory: document.getElementById('input-category'),
            categoryDropdownBtn: document.getElementById('category-dropdown-btn'),
            categoryDropdownMenu: document.getElementById('category-dropdown-menu'),
            selectedCategoryDisplay: document.getElementById('selected-category-display'),
            inputPrice: document.getElementById('input-price'),
            inputQuantity: document.getElementById('input-quantity'),
            inputUnit: document.getElementById('input-unit'),
            unitDropdownBtn: document.getElementById('unit-dropdown-btn'),
            unitDropdownMenu: document.getElementById('unit-dropdown-menu'),
            selectedUnitDisplay: document.getElementById('selected-unit-display'),
            addBtn: document.getElementById('add-btn'),
            // Displays
            budgetDisplay: document.getElementById('budget-display'),
            budgetTitleDisplay: document.getElementById('budget-title-display'),
            budgetLimitDisplay: document.getElementById('budget-limit-display'),
            progressBar: document.getElementById('progress-bar'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            estimatedTotal: document.getElementById('estimated-total'),
            remainingBudget: document.getElementById('remaining-budget'),
            footerTotal: document.getElementById('footer-total'),
            footerRemainingCount: document.getElementById('footer-remaining-count'),
            // Theme specific
            budgetCard: document.getElementById('budget-card'),
            menuCard: document.getElementById('menu-card'),
            menuTitle: document.getElementById('menu-title'),
            // Modal Delete
            deleteModal: document.getElementById('delete-modal'),
            deleteModalContent: document.getElementById('delete-modal-content'),
            deleteModalTitle: document.getElementById('delete-modal-title'),
            deleteModalText: document.getElementById('delete-modal-text'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            // Add Item Modal
            addItemModal: document.getElementById('add-item-modal'),
            addItemModalContent: document.getElementById('add-item-modal-content'),
            addItemModalTitle: document.getElementById('add-item-modal-title'),
            cancelAddBtn: document.getElementById('cancel-add-btn'),
            // confirmAddBtn is dom.addBtn (reused ID)
            openAddModalBtn: document.getElementById('open-add-modal-btn'),
            
            // Recipes Elements
            recipesBtn: document.getElementById('recipes-btn'),
            recipesModal: document.getElementById('recipes-modal'),
            recipesModalContent: document.getElementById('recipes-modal-content'),
            recipesModalTitle: document.getElementById('recipes-modal-title'),
            closeRecipesModalBtn: document.getElementById('close-recipes-modal-btn'),
            recipesList: document.getElementById('recipes-list'),
            openNewRecipeModalBtn: document.getElementById('open-new-recipe-modal-btn'),
            
            newRecipeModal: document.getElementById('new-recipe-modal'),
            newRecipeModalContent: document.getElementById('new-recipe-modal-content'),
            newRecipeModalTitle: document.getElementById('new-recipe-modal-title'),
            recipeNameInput: document.getElementById('recipe-name-input'),
            recipeIngredientsList: document.getElementById('recipe-ingredients-list'),
            addIngredientBtn: document.getElementById('add-ingredient-btn'),
            cancelRecipeBtn: document.getElementById('cancel-recipe-btn'),
            saveRecipeBtn: document.getElementById('save-recipe-btn'),

            // Search
            searchInput: document.getElementById('search-input'),

            // Edit Modal
            editModal: document.getElementById('edit-modal'),
            editModalContent: document.getElementById('edit-modal-content'),
            editModalTitle: document.getElementById('edit-modal-title'),
            editNameInput: document.getElementById('edit-name-input'),
            editCategorySelect: document.getElementById('edit-category-select'), // Now a hidden input
            editCategoryDropdownBtn: document.getElementById('edit-category-dropdown-btn'),
            editCategoryDropdownMenu: document.getElementById('edit-category-dropdown-menu'),
            editSelectedCategoryDisplay: document.getElementById('edit-selected-category-display'),
            editPriceInput: document.getElementById('edit-price-input'),
            editQuantityInput: document.getElementById('edit-quantity-input'),
            editUnitInput: document.getElementById('edit-unit-input'),
            editUnitDropdownBtn: document.getElementById('edit-unit-dropdown-btn'),
            editUnitDropdownMenu: document.getElementById('edit-unit-dropdown-menu'),
            editSelectedUnitDisplay: document.getElementById('edit-selected-unit-display'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            saveEditBtn: document.getElementById('save-edit-btn'),
            // Modal Category
            addCategoryModal: document.getElementById('add-category-modal'),
            addCategoryModalContent: document.getElementById('add-category-modal-content'),
            addCategoryModalTitle: document.getElementById('add-category-modal-title'),
            newCategoryInput: document.getElementById('new-category-input'),
            cancelCategoryBtn: document.getElementById('cancel-category-btn'),
            confirmCategoryBtn: document.getElementById('confirm-category-btn'),
            // Finish Shopping
            finishShopBtn: document.getElementById('finish-shop-btn'),
            finishModal: document.getElementById('finish-modal'),
            finishModalContent: document.getElementById('finish-modal-content'),
            finishModalTitle: document.getElementById('finish-modal-title'),
            finishModalText: document.getElementById('finish-modal-text'),
            cancelFinishBtn: document.getElementById('cancel-finish-btn'),
            confirmFinishBtn: document.getElementById('confirm-finish-btn'),
            // Settings
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            settingsModalContent: document.getElementById('settings-modal-content'),
            settingsModalTitle: document.getElementById('settings-modal-title'),
            settingsAppName: document.getElementById('settings-app-name'),
            settingsRoundContainer: document.getElementById('settings-round-container'),
            settingsRoundToggle: document.getElementById('settings-round-toggle'),
            settingsRoundKnob: document.getElementById('settings-round-knob'),
            settingsRoundLabel: document.getElementById('settings-round-label'),
            // Suggestions Settings
            settingsSuggestionsContainer: document.getElementById('settings-suggestions-container'),
            settingsSuggestionsToggle: document.getElementById('settings-suggestions-toggle'),
            settingsSuggestionsKnob: document.getElementById('settings-suggestions-knob'),
            settingsSuggestionsLabel: document.getElementById('settings-suggestions-label'),
            
            labelAppName: document.getElementById('label-app-name'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            
            // Suggestions Dropdown
            suggestionsDropdown: document.getElementById('suggestions-dropdown'),

            // Confirmation Settings Elements
            settingsConfirmationsTitle: document.getElementById('settings-confirmations-title'),
            settingsConfirmBudgetContainer: document.getElementById('settings-confirm-budget-container'),
            settingsConfirmBudgetToggle: document.getElementById('settings-confirm-budget-toggle'),
            settingsConfirmBudgetKnob: document.getElementById('settings-confirm-budget-knob'),
            settingsConfirmBudgetLabel: document.getElementById('settings-confirm-budget-label'),

            settingsConfirmItemContainer: document.getElementById('settings-confirm-item-container'),
            settingsConfirmItemToggle: document.getElementById('settings-confirm-item-toggle'),
            settingsConfirmItemKnob: document.getElementById('settings-confirm-item-knob'),
            settingsConfirmItemLabel: document.getElementById('settings-confirm-item-label'),

            settingsConfirmSuggestionContainer: document.getElementById('settings-confirm-suggestion-container'),
            settingsConfirmSuggestionToggle: document.getElementById('settings-confirm-suggestion-toggle'),
            settingsConfirmSuggestionKnob: document.getElementById('settings-confirm-suggestion-knob'),
            settingsConfirmSuggestionLabel: document.getElementById('settings-confirm-suggestion-label'),

            settingsConfirmFinishContainer: document.getElementById('settings-confirm-finish-container'),
            settingsConfirmFinishToggle: document.getElementById('settings-confirm-finish-toggle'),
            settingsConfirmFinishKnob: document.getElementById('settings-confirm-finish-knob'),
            settingsConfirmFinishLabel: document.getElementById('settings-confirm-finish-label'),

            // Delete Suggestion Modal
            deleteSuggestionModal: document.getElementById('delete-suggestion-modal'),
            deleteSuggestionModalContent: document.getElementById('delete-suggestion-modal-content'),
            deleteSuggestionModalTitle: document.getElementById('delete-suggestion-modal-title'),
            deleteSuggestionModalText: document.getElementById('delete-suggestion-modal-text'),
            cancelDeleteSuggestionBtn: document.getElementById('cancel-delete-suggestion-btn'),
            confirmDeleteSuggestionBtn: document.getElementById('confirm-delete-suggestion-btn'),
            
            // New Budget Modal
            newBudgetModal: document.getElementById('new-budget-modal'),
            newBudgetModalContent: document.getElementById('new-budget-modal-content'),
            newBudgetModalTitle: document.getElementById('new-budget-modal-title'),
            newBudgetName: document.getElementById('new-budget-name'),
            newBudgetLimit: document.getElementById('new-budget-limit'),
            cancelNewBudgetBtn: document.getElementById('cancel-new-budget-btn'),
            createBudgetBtn: document.getElementById('create-budget-btn'),
            openNewBudgetModalBtn: document.getElementById('open-new-budget-modal-btn'),

            // Edit Hub Budget Modal
            editHubBudgetModal: document.getElementById('edit-hub-budget-modal'),
            editHubBudgetModalContent: document.getElementById('edit-hub-budget-modal-content'),
            editHubBudgetModalTitle: document.getElementById('edit-hub-budget-modal-title'),
            editHubBudgetName: document.getElementById('edit-hub-budget-name'),
            editHubBudgetLimit: document.getElementById('edit-hub-budget-limit'),
            cancelEditHubBudgetBtn: document.getElementById('cancel-edit-hub-budget-btn'),
            saveEditHubBudgetBtn: document.getElementById('save-edit-hub-budget-btn'),
            
            // Hub Theme Elements
            hubTitle: document.getElementById('hub-title'),
            hubSubtitle: document.getElementById('hub-subtitle'),

            // Delete Budget Modal
            deleteBudgetModal: document.getElementById('delete-budget-modal'),
            deleteBudgetModalContent: document.getElementById('delete-budget-modal-content'),
            deleteBudgetModalTitle: document.getElementById('delete-budget-modal-title'),
            deleteBudgetModalText: document.getElementById('delete-budget-modal-text'),
            cancelDeleteBudgetBtn: document.getElementById('cancel-delete-budget-btn'),
            confirmDeleteBudgetBtn: document.getElementById('confirm-delete-budget-btn'),

            // Tutorial Elements
            tutorialBtn: document.getElementById('tutorial-btn'),
            tutorialModal: document.getElementById('tutorial-modal'),
            tutorialModalContent: document.getElementById('tutorial-modal-content'),
            tutorialModalTitle: document.getElementById('tutorial-modal-title'),
            tutorialModalText: document.getElementById('tutorial-modal-text'),
            closeTutorialBtn: document.getElementById('close-tutorial-btn'),
            okTutorialBtn: document.getElementById('ok-tutorial-btn')
        };

        // --- L√ìGICA DE NEG√ìCIO E UI ---

        function formatCurrency(value) {
            if (state.roundValues) {
                return Math.round(value).toFixed(0);
            }
            return value.toFixed(2);
        }

        async function init() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const progressBar = document.getElementById('loading-progress');
            const offlineWarning = document.getElementById('offline-warning');
            
            // Start progress animation
            if (progressBar) {
                // Small delay to ensure DOM is ready for transition
                setTimeout(() => {
                    progressBar.style.width = '95%'; // Go to 95% over 3 minutes
                }, 100);
            }
            
            let retries = 0;
            const maxRetries = 3;

            // Loop until API connects
            while (true) {
                if (!navigator.onLine) {
                    console.log('Offline detected. Skipping API fetch.');
                    break;
                }

                try {
                    // Carregar or√ßamentos
                    const budgets = await apiService.fetchBudgets();
                    state.budgets = budgets;

                    // Carregar produtos (sugest√µes)
                    state.products = await apiService.fetchProducts();
                    // updateProductDatalist(); // Removed in favor of custom dropdown

                    break; // Success!
                } catch (e) {
                    console.log('Aguardando API...', e);
                    retries++;
                    if (retries >= maxRetries) {
                        console.log('Max retries reached. Entering offline mode.');
                        break;
                    }
                    await new Promise(r => setTimeout(r, 2000)); // Retry every 2s
                }
            }
            
            // Check if offline or failed
            if (!navigator.onLine || retries >= maxRetries) {
                if (offlineWarning) offlineWarning.classList.remove('hidden');
                // Initialize with empty state or cached data if implemented
                state.budgets = []; 
                state.products = [];
            }

            // Load Recipes
            loadRecipes();

            // Finish progress
            if (progressBar) {
                progressBar.style.transition = 'width 0.5s ease-out'; // Fast finish
                progressBar.style.width = '100%';
            }
            
            // Hide loading
            if (loadingOverlay) {
                // Wait for the fast finish
                await new Promise(r => setTimeout(r, 500));
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.classList.add('hidden'), 500);
            }
            
            renderAll();
        }

        function syncLocalState() {
            if (!state.activeBudgetId) return;
            const budgetIndex = state.budgets.findIndex(b => b.id === state.activeBudgetId);
            if (budgetIndex !== -1) {
                state.budgets[budgetIndex].items = state.items;
                state.budgets[budgetIndex].categories = state.categories;
                state.budgets[budgetIndex].title = state.budgetTitle;
                state.budgets[budgetIndex].limit = state.budgetLimit;
            }
        }

        async function saveActiveBudgetMetadata() {
            syncLocalState();
            
            // Persist metadata to API
            await apiService.updateBudget(state.activeBudgetId, {
                title: state.budgetTitle,
                limit: state.budgetLimit,
                categories: state.categories
            });
        }

        // --- HUB LOGIC ---

        function openHub() {
            state.view = 'hub';
            state.activeBudgetId = null;
            state.shopMode = false; // Reset shop mode when going back to hub
            
            // Hide Share Button
            const shareBtn = document.getElementById('share-btn');
            if(shareBtn) shareBtn.classList.add('hidden');
            
            // Hide Back Button
            if(dom.backToHubBtn) dom.backToHubBtn.classList.add('hidden');

            renderAll();
        }

        function openDashboard(budgetId) {
            const budget = state.budgets.find(b => b.id === budgetId);
            if (!budget) return;

            state.activeBudgetId = budgetId;
            state.view = 'dashboard';
            
            // Show Share Button
            const shareBtn = document.getElementById('share-btn');
            if(shareBtn) shareBtn.classList.remove('hidden');

            // Show Back Button
            if(dom.backToHubBtn) dom.backToHubBtn.classList.remove('hidden');
            
            // Load budget data into active state
            state.budgetTitle = budget.title;
            state.budgetLimit = budget.limit;
            state.items = budget.items || [];
            state.categories = budget.categories || ['Geral'];
            
            renderAll();
        }

        function openNewBudgetModal() {
            dom.newBudgetName.value = '';
            dom.newBudgetLimit.value = '';
            // Reset validation styles
            dom.newBudgetName.classList.remove('ring-2', 'ring-rose-500');
            dom.newBudgetLimit.classList.remove('ring-2', 'ring-rose-500');
            dom.newBudgetModal.classList.remove('hidden');
            dom.newBudgetName.focus();
        }

        function closeNewBudgetModal() {
            dom.newBudgetModal.classList.add('hidden');
        }

        async function handleCreateBudget() {
            const name = dom.newBudgetName.value.trim();
            const limitValue = dom.newBudgetLimit.value;
            const limit = parseFloat(limitValue);

            // Reset validation
            dom.newBudgetName.classList.remove('ring-2', 'ring-rose-500');
            dom.newBudgetLimit.classList.remove('ring-2', 'ring-rose-500');

            let hasError = false;

            if (!name) {
                dom.newBudgetName.classList.add('ring-2', 'ring-rose-500');
                hasError = true;
            }

            if (!limitValue || isNaN(limit)) {
                dom.newBudgetLimit.classList.add('ring-2', 'ring-rose-500');
                hasError = true;
            }

            if (hasError) return;

            closeNewBudgetModal();

            const newBudget = {
                title: name,
                limit: limit,
                items: [],
                categories: ['Geral']
            };

            const created = await apiService.createBudget(newBudget);
            state.budgets.push(created);
            
            renderAll();
        }

        let editingBudgetId = null;

        function openEditHubBudgetModal(id, event) {
            if(event) event.stopPropagation();
            if (!id || id === 'null' || id === 'undefined') {
                console.error('Tentativa de editar or√ßamento com ID inv√°lido:', id);
                return;
            }

            const budget = state.budgets.find(b => b.id === id);
            if(!budget) return;

            editingBudgetId = id;
            dom.editHubBudgetName.value = budget.title;
            dom.editHubBudgetLimit.value = budget.limit;
            
            // Reset validation
            dom.editHubBudgetName.classList.remove('ring-2', 'ring-rose-500');
            dom.editHubBudgetLimit.classList.remove('ring-2', 'ring-rose-500');

            dom.editHubBudgetModal.classList.remove('hidden');
            dom.editHubBudgetName.focus();
        }

        function closeEditHubBudgetModal() {
            editingBudgetId = null;
            dom.editHubBudgetModal.classList.add('hidden');
        }

        async function handleSaveEditHubBudget() {
            if(!editingBudgetId || editingBudgetId === 'null' || editingBudgetId === 'undefined') return;

            const name = dom.editHubBudgetName.value.trim();
            const limitValue = dom.editHubBudgetLimit.value;
            const limit = parseFloat(limitValue);

             // Reset validation
            dom.editHubBudgetName.classList.remove('ring-2', 'ring-rose-500');
            dom.editHubBudgetLimit.classList.remove('ring-2', 'ring-rose-500');

            let hasError = false;
            if (!name) {
                dom.editHubBudgetName.classList.add('ring-2', 'ring-rose-500');
                hasError = true;
            }
            if (!limitValue || isNaN(limit)) {
                dom.editHubBudgetLimit.classList.add('ring-2', 'ring-rose-500');
                hasError = true;
            }

            if (hasError) return;

            const idToUpdate = editingBudgetId; // Capture ID before closing modal

            const budgetIndex = state.budgets.findIndex(b => b.id === idToUpdate);
            if(budgetIndex !== -1) {
                // Preserve existing properties (items, categories, etc)
                const updatedBudget = { 
                    ...state.budgets[budgetIndex], 
                    title: name, 
                    limit: limit 
                };
                
                // Optimistic
                state.budgets[budgetIndex] = updatedBudget;
                renderHub();
                lucide.createIcons();
                closeEditHubBudgetModal();

                // API
                try {
                    await apiService.updateBudget(idToUpdate, { title: name, limit: limit });
                } catch (error) {
                    console.error('Failed to update budget:', error);
                    // Revert on error if needed, or show alert
                }
            }
        }

        let budgetToDeleteId = null;

        function openDeleteBudgetModal(id) {
            budgetToDeleteId = id;
            
            if (!state.confirmDeleteBudget) {
                confirmDeleteBudget();
                return;
            }

            dom.deleteBudgetModal.classList.remove('hidden');
        }

        function closeDeleteBudgetModal() {
            budgetToDeleteId = null;
            dom.deleteBudgetModal.classList.add('hidden');
        }

        async function confirmDeleteBudget() {
            if (budgetToDeleteId) {
                const id = budgetToDeleteId;
                closeDeleteBudgetModal();
                
                // Optimistic update
                state.budgets = state.budgets.filter(b => b.id !== id);
                renderAll();

                // Call API
                await apiService.deleteBudget(id);
            }
        }

        async function handleDuplicateBudget(id, e) {
            if (e) e.stopPropagation();
            const budget = state.budgets.find(b => b.id === id);
            if (!budget) return;

            const newBudget = {
                title: `${budget.title} (C√≥pia)`,
                limit: budget.limit,
                items: budget.items.map(item => ({ ...item, checked: false })),
                categories: budget.categories
            };

            try {
                const created = await apiService.createBudget(newBudget);
                state.budgets.push(created);
                renderAll();
            } catch (error) {
                console.error('Erro ao duplicar:', error);
                alert('Erro ao duplicar or√ßamento.');
            }
        }

        async function handleDeleteBudget(id, e) {
            if (e) e.stopPropagation();
            openDeleteBudgetModal(id);
        }

        // --- RENDERIZA√á√ÉO ---

        function renderHub() {
            const grid = dom.hubGrid;
            grid.innerHTML = '';
            const isDark = state.theme === 'dark';

            state.budgets.forEach(budget => {
                if (!budget || !budget.id) return; // Skip invalid budgets

                const totalSpent = (budget.items || []).reduce((acc, item) => acc + (item.checked ? (item.price * (item.quantity || 1)) : 0), 0);
                const progress = Math.min((totalSpent / budget.limit) * 100, 100);
                
                const card = document.createElement('div');
                card.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-700 hover:border-indigo-500 transition-all cursor-pointer group relative'
                    : 'bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:border-indigo-300 transition-all cursor-pointer group relative';
                
                card.onclick = () => openDashboard(budget.id);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 rounded-xl ${isDark ? 'bg-gray-700 text-indigo-400' : 'bg-indigo-50 text-indigo-600'} group-hover:scale-110 transition-transform">
                            <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openEditHubBudgetModal('${budget.id}', event)" class="p-2 rounded-lg text-slate-400 hover:text-indigo-500 hover:bg-slate-100 transition-colors" title="Editar">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="handleDuplicateBudget('${budget.id}', event)" class="p-2 rounded-lg text-slate-400 hover:text-indigo-500 hover:bg-slate-100 transition-colors" title="Duplicar">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <button onclick="handleDeleteBudget('${budget.id}', event)" class="p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-slate-100 transition-colors" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold mb-1 truncate ${isDark ? 'text-white' : 'text-slate-800'}" title="${budget.title}">${budget.title}</h3>
                    <p class="text-sm ${isDark ? 'text-gray-400' : 'text-slate-500'} mb-6">R$ ${formatCurrency(totalSpent)} / R$ ${formatCurrency(budget.limit)}</p>
                    
                    <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden ${isDark ? 'bg-gray-700' : 'bg-slate-100'}">
                        <div class="h-2 rounded-full ${progress > 90 ? 'bg-red-500' : 'bg-green-500'} transition-all" style="width: ${progress}%"></div>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Create New Card
            const createCard = document.createElement('div');
            createCard.className = isDark
                ? 'bg-gray-800/50 border-2 border-dashed border-gray-700 rounded-2xl p-6 flex flex-col items-center justify-center text-gray-500 hover:text-indigo-400 hover:border-indigo-500 hover:bg-gray-800 transition-all cursor-pointer min-h-[200px]'
                : 'bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl p-6 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-300 hover:bg-white transition-all cursor-pointer min-h-[200px]';
            
            createCard.onclick = openNewBudgetModal;
            createCard.innerHTML = `
                <div class="p-4 rounded-full bg-slate-100 mb-4 group-hover:bg-indigo-50 transition-colors ${isDark ? 'bg-gray-700' : ''}">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </div>
                <span class="font-medium">Criar Novo Or√ßamento</span>
            `;
            grid.appendChild(createCard);
        }



        function renderCategories() {
            const menu = dom.categoryDropdownMenu;
            const currentValue = dom.inputCategory.value;
            const isDark = state.theme === 'dark' || state.shopMode;
            const isShop = state.shopMode;
            menu.innerHTML = '';
            
            state.categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = isDark 
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-gray-300 transition-colors flex items-center justify-between group'
                    : 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors flex items-center justify-between group';
                
                // Content wrapper
                const content = document.createElement('div');
                content.className = 'flex items-center gap-2 min-w-0 flex-1';
                
                const dotColor = isShop ? 'bg-shop-500' : 'bg-indigo-500';
                content.innerHTML = `<span class="w-2 h-2 rounded-full ${dotColor} flex-shrink-0"></span><span class="truncate" title="${cat}">${cat}</span>`;
                
                item.appendChild(content);

                // Delete button (only for non-Geral)
                if (cat !== 'Geral') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all p-1';
                    deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-3 h-3"></i>';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        openDeleteCategoryModal(cat);
                    };
                    item.appendChild(deleteBtn);
                }

                item.onclick = () => selectCategory(cat);
                menu.appendChild(item);
            });
            
            // Divider
            const divider = document.createElement('div');
            divider.className = isDark ? 'h-px bg-gray-700 my-1' : 'h-px bg-slate-100 my-1';
            menu.appendChild(divider);

            // Op√ß√£o para adicionar nova
            const newItem = document.createElement('div');
            let newItemClass = '';
            
            if (isShop) {
                newItemClass = isDark
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-shop-400 font-medium transition-colors flex items-center gap-2'
                    : 'px-4 py-2 hover:bg-shop-50 cursor-pointer text-sm text-shop-600 font-medium transition-colors flex items-center gap-2';
            } else {
                newItemClass = isDark
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-indigo-400 font-medium transition-colors flex items-center gap-2'
                    : 'px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm text-indigo-600 font-medium transition-colors flex items-center gap-2';
            }
            
            newItem.className = newItemClass;
            newItem.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> Nova Categoria...`;
            newItem.onclick = () => {
                toggleCategoryDropdown();
                openAddCategoryModal();
            };
            menu.appendChild(newItem);

            // Restaurar valor se poss√≠vel, sen√£o Geral
            if (state.categories.includes(currentValue)) {
                selectCategory(currentValue, false);
            } else {
                selectCategory('Geral', false);
            }
            
            lucide.createIcons();
        }

        function toggleCategoryDropdown() {
            if (!dom.categoryDropdownMenu) return;
            dom.categoryDropdownMenu.classList.toggle('hidden');
            
            if (dom.categoryDropdownBtn) {
                const icon = dom.categoryDropdownBtn.querySelector('i') || dom.categoryDropdownBtn.querySelector('svg');
                if (icon) {
                    if (dom.categoryDropdownMenu.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }
        }

        function selectCategory(cat, close = true) {
            dom.inputCategory.value = cat;
            dom.selectedCategoryDisplay.textContent = cat;
            if (close) toggleCategoryDropdown();
        }

        function renderUnitDropdown() {
            const menu = dom.unitDropdownMenu;
            if (!menu) return;
            
            const units = ['un', 'kg', 'g', 'L', 'ml', 'cx', 'pct'];
            const currentValue = dom.inputUnit ? dom.inputUnit.value : 'un';
            const isDark = state.theme === 'dark' || state.shopMode;
            menu.innerHTML = '';
            
            units.forEach(unit => {
                const item = document.createElement('div');
                item.className = isDark 
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-gray-300 transition-colors text-center'
                    : 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors text-center';
                
                item.textContent = unit;
                item.onclick = () => selectUnit(unit);
                menu.appendChild(item);
            });

            // Restore value
            if (units.includes(currentValue)) {
                selectUnit(currentValue, false);
            } else {
                selectUnit('un', false);
            }
        }

        function toggleUnitDropdown() {
            if (!dom.unitDropdownMenu) return;
            dom.unitDropdownMenu.classList.toggle('hidden');
            
            if (dom.unitDropdownBtn) {
                const icon = dom.unitDropdownBtn.querySelector('i') || dom.unitDropdownBtn.querySelector('svg');
                if (icon) {
                    if (dom.unitDropdownMenu.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }
        }

        function selectUnit(unit, close = true) {
            if(dom.inputUnit) dom.inputUnit.value = unit;
            if(dom.selectedUnitDisplay) dom.selectedUnitDisplay.textContent = unit;
            if (close) toggleUnitDropdown();
        }

        // --- EDIT MODAL DROPDOWNS ---

        function renderEditCategories() {
            const menu = dom.editCategoryDropdownMenu;
            if (!menu) return;
            
            const currentValue = dom.editCategorySelect.value;
            const isDark = state.theme === 'dark'; // Edit modal always follows theme, not shop mode
            menu.innerHTML = '';
            
            state.categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = isDark 
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-gray-300 transition-colors flex items-center justify-between group'
                    : 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors flex items-center justify-between group';
                
                const content = document.createElement('div');
                content.className = 'flex items-center gap-2 min-w-0 flex-1';
                content.innerHTML = `<span class="w-2 h-2 rounded-full bg-indigo-500 flex-shrink-0"></span><span class="truncate" title="${cat}">${cat}</span>`;
                item.appendChild(content);

                item.onclick = () => selectEditCategory(cat);
                menu.appendChild(item);
            });

            if (state.categories.includes(currentValue)) {
                selectEditCategory(currentValue, false);
            } else {
                selectEditCategory('Geral', false);
            }
        }

        function toggleEditCategoryDropdown() {
            if (!dom.editCategoryDropdownMenu) return;
            dom.editCategoryDropdownMenu.classList.toggle('hidden');
            
            if (dom.editCategoryDropdownBtn) {
                const icon = dom.editCategoryDropdownBtn.querySelector('i') || dom.editCategoryDropdownBtn.querySelector('svg');
                if (icon) {
                    if (dom.editCategoryDropdownMenu.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }
        }

        function selectEditCategory(cat, close = true) {
            dom.editCategorySelect.value = cat;
            dom.editSelectedCategoryDisplay.textContent = cat;
            if (close) toggleEditCategoryDropdown();
        }

        function renderEditUnitDropdown() {
            const menu = dom.editUnitDropdownMenu;
            if (!menu) return;
            
            const units = ['un', 'kg', 'g', 'L', 'ml', 'cx', 'pct'];
            const currentValue = dom.editUnitInput ? dom.editUnitInput.value : 'un';
            const isDark = state.theme === 'dark';
            menu.innerHTML = '';
            
            units.forEach(unit => {
                const item = document.createElement('div');
                item.className = isDark 
                    ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-gray-300 transition-colors text-center'
                    : 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors text-center';
                
                item.textContent = unit;
                item.onclick = () => selectEditUnit(unit);
                menu.appendChild(item);
            });

            if (units.includes(currentValue)) {
                selectEditUnit(currentValue, false);
            } else {
                selectEditUnit('un', false);
            }
        }

        function toggleEditUnitDropdown() {
            if (!dom.editUnitDropdownMenu) return;
            dom.editUnitDropdownMenu.classList.toggle('hidden');
            
            if (dom.editUnitDropdownBtn) {
                const icon = dom.editUnitDropdownBtn.querySelector('i') || dom.editUnitDropdownBtn.querySelector('svg');
                if (icon) {
                    if (dom.editUnitDropdownMenu.classList.contains('hidden')) {
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
            }
        }

        function selectEditUnit(unit, close = true) {
            if(dom.editUnitInput) dom.editUnitInput.value = unit;
            if(dom.editSelectedUnitDisplay) dom.editSelectedUnitDisplay.textContent = unit;
            if (close) toggleEditUnitDropdown();
        }

        function renderAll() {
            // View Switching
            if (state.view === 'hub') {
                dom.hubSection.classList.remove('hidden');
                dom.dashboardSection.classList.add('hidden');
                dom.backToHubBtn.classList.add('hidden');
                renderHub();
            } else {
                dom.hubSection.classList.add('hidden');
                dom.dashboardSection.classList.remove('hidden');
                dom.backToHubBtn.classList.remove('hidden');
                
                renderStats();
                renderList();
            }

            renderHeaderInfo();
            updateTheme();
            lucide.createIcons();
        }

        function renderHeaderInfo() {
            const titleEl = dom.header.querySelector('h1');
            const sloganEl = dom.modeText;
            
            if (titleEl) titleEl.textContent = state.appName;
            if (sloganEl && !state.shopMode) sloganEl.textContent = state.appSlogan;
        }

        function renderStats() {
            const totalEstimated = state.items.reduce((acc, curr) => acc + (curr.price * (curr.quantity || 1)), 0);
            const totalInCart = state.items.filter(i => i.checked).reduce((acc, curr) => acc + (curr.price * (curr.quantity || 1)), 0);
            const remaining = state.budgetLimit - totalInCart;
            const rawProgress = (totalInCart / state.budgetLimit) * 100;
            const progress = Math.min(rawProgress, 100);
            const remainingCount = state.items.filter(i => !i.checked).length;

            // Atualiza Dashboard
            if (dom.budgetTitleDisplay) dom.budgetTitleDisplay.textContent = state.budgetTitle;
            dom.budgetDisplay.innerHTML = `R$ ${formatCurrency(totalInCart)} <span class="text-base font-normal opacity-60">/ R$ ${state.budgetLimit}</span>`;
            dom.progressBar.style.width = `${progress}%`;
            
            // Smart Progress Bar Colors
            let colorClass = 'bg-emerald-500';
            if (rawProgress > 100) colorClass = 'bg-purple-600 animate-pulse shadow-[0_0_10px_rgba(147,51,234,0.5)]';
            else if (rawProgress > 85) colorClass = 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.3)]';
            else if (rawProgress > 50) colorClass = 'bg-amber-500';

            dom.progressBar.className = `h-3 rounded-full transition-all duration-1000 ${colorClass}`;
            
            dom.estimatedTotal.textContent = `Est: R$ ${formatCurrency(totalEstimated)}`;
            dom.remainingBudget.textContent = `Resta: R$ ${formatCurrency(remaining)}`;

            // Atualiza Footer (Modo Loja)
            dom.footerTotal.textContent = `R$ ${formatCurrency(totalInCart)}`;
            dom.footerRemainingCount.textContent = remainingCount;
        }

        function handleSort(value) {
            state.sortBy = value;
            renderList();
        }

        function toggleSortDropdown() {
            const menu = document.getElementById('sort-dropdown-menu');
            if (!menu) return;
            menu.classList.toggle('hidden');
        }

        function selectSort(value, text) {
            state.sortBy = value;
            document.getElementById('selected-sort-display').textContent = text;
            toggleSortDropdown();
            renderList();
        }

        function renderList() {
            dom.itemsContainer.innerHTML = '';

            // Filter items based on search term
            let filteredItems = state.items;
            if (state.searchTerm) {
                const term = state.searchTerm.toLowerCase();
                filteredItems = state.items.filter(item => 
                    item.name.toLowerCase().includes(term) || 
                    item.category.toLowerCase().includes(term)
                );
            }

            if (filteredItems.length === 0) {
                if (state.searchTerm) {
                    dom.itemsContainer.innerHTML = `
                        <div class="text-center py-12 opacity-50">
                            <i data-lucide="search-x" class="mx-auto mb-3 w-12 h-12"></i>
                            <p>Nenhum item encontrado para "${state.searchTerm}".</p>
                        </div>`;
                } else {
                    dom.itemsContainer.innerHTML = `
                        <div class="text-center py-12 opacity-50">
                            <i data-lucide="shopping-cart" class="mx-auto mb-3 w-12 h-12"></i>
                            <p>Sua lista est√° vazia.</p>
                        </div>`;
                }
                return;
            }

            // Sorting
            let itemsToSort = [...filteredItems];
            const sortType = state.sortBy || 'default';

            if (sortType === 'price-desc') {
                itemsToSort.sort((a, b) => b.price - a.price);
            } else if (sortType === 'price-asc') {
                itemsToSort.sort((a, b) => a.price - b.price);
            } else if (sortType === 'name-asc') {
                itemsToSort.sort((a, b) => a.name.localeCompare(b.name));
            }

            // Agrupar
            const groups = {};
            // Ensure groups follow state.categories order
            state.categories.forEach(cat => {
                groups[cat] = [];
            });
            
            // Fill groups
            itemsToSort.forEach(item => {
                if (!groups[item.category]) {
                    // Fallback for items with categories not in the list (shouldn't happen but safe)
                    if(!groups['Outros']) groups['Outros'] = [];
                    groups['Outros'].push(item);
                } else {
                    groups[item.category].push(item);
                }
            });

            // Gerar HTML
            // Iterate over state.categories to maintain order
            const categoriesToRender = [...state.categories];
            if(groups['Outros'] && groups['Outros'].length > 0) categoriesToRender.push('Outros');

            categoriesToRender.forEach((category, index) => {
                const items = groups[category] || [];
                
                // Skip empty categories logic
                // If searching, only show categories with matches
                if (state.searchTerm && items.length === 0) return;

                // Default skip logic
                if (!state.searchTerm && state.categories.length > 1 && items.length === 0) return;
                
                // If shop mode and empty, definitely skip
                if (state.shopMode && items.length === 0) return;

                const groupDiv = document.createElement('div');
                const isShopMode = state.shopMode;
                const isDark = state.theme === 'dark';
                
                // Estilos base do container do grupo
                const containerClass = isDark 
                    ? 'bg-gray-800 border-gray-700' 
                    : 'bg-white border-slate-100';
                
                const headerClass = isDark
                    ? 'bg-gray-700 text-gray-300'
                    : 'bg-slate-50 text-slate-500';

                groupDiv.className = `${containerClass} rounded-xl shadow-sm border overflow-hidden transition-colors duration-500 mb-6`;

                let itemsHtml = '';
                items.forEach(item => {
                    const checkedClass = item.checked 
                        ? (isDark ? 'opacity-30 bg-gray-800' : 'opacity-40 bg-slate-50')
                        : '';
                    
                    const textClass = item.checked ? 'line-through' : '';
                    const textColor = isDark ? 'text-white' : 'text-slate-800';
                    const hoverClass = isDark ? 'hover:bg-gray-700' : 'hover:bg-slate-50';
                    const borderClass = isDark ? 'border-gray-700' : 'border-slate-50';

                    // Check circle style
                    let circleStyle = '';
                    if (item.checked) {
                        circleStyle = 'bg-green-500 border-green-500 scale-110';
                    } else {
                        circleStyle = isDark ? 'border-gray-500' : 'border-slate-300 group-hover:border-indigo-400';
                    }

                    // Calculate total for this item line
                    const qty = item.quantity || 1;
                    const unit = item.unit || 'un';
                    const totalItemPrice = (item.price || 0) * qty;

                    // Display Quantity Logic
                    let qtyDisplay = '';
                    if (unit === 'un') {
                        if (qty > 1) qtyDisplay = `<span class="text-indigo-500 font-bold mr-1">${qty}x</span>`;
                    } else {
                        qtyDisplay = `<span class="text-indigo-500 font-bold mr-1">${qty}${unit}</span>`;
                    }

                    // Delete button logic (Hide in shop mode unless necessary, here hiding for simplicity)
                    const deleteBtn = isShopMode 
                        ? (totalItemPrice > 0 ? `<span class="text-gray-400 font-mono">R$${formatCurrency(totalItemPrice)}</span>` : '')
                        : `<div class="flex items-center gap-2">
                            <div class="text-right mr-2">
                                <span class="text-slate-600 font-medium text-sm block">${totalItemPrice > 0 ? 'R$ ' + formatCurrency(totalItemPrice) : ''}</span>
                                ${qty > 1 ? `<span class="text-xs text-slate-400 block">${qty}${unit} R$ ${formatCurrency(item.price)}</span>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); openEditModal('${item.id}')" class="text-slate-300 hover:text-indigo-500 p-2 transition-colors" title="Editar">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="handleDelete('${item.id}', event)" class="text-slate-300 hover:text-red-500 p-2 transition-colors" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                           </div>`;

                    itemsHtml += `
                        <div onclick="handleToggle('${item.id}')" class="group flex items-center justify-between p-4 cursor-pointer transition-all border-b last:border-0 ${borderClass} ${hoverClass} ${checkedClass}">
                            <div class="flex items-center gap-4 min-w-0 flex-1">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${circleStyle}">
                                    ${item.checked ? '<i data-lucide="check" class="text-white w-3 h-3"></i>' : ''}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-medium transition-all truncate ${textClass} ${textColor} ${isShopMode ? 'text-lg' : ''}" title="${item.name}">
                                        ${qtyDisplay}
                                        ${item.name}
                                    </p>
                                    ${!isShopMode && item.price > 0 ? `<p class="text-xs text-slate-400 mt-0.5">Est: R$ ${formatCurrency(totalItemPrice)}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex-shrink-0 ml-2">
                                ${deleteBtn}
                            </div>
                        </div>
                    `;
                });

                // Category Header with Reordering
                let reorderControls = '';
                if (!isShopMode && category !== 'Outros') {
                    const isFirst = index === 0;
                    const isLast = index === state.categories.length - 1;
                    
                    reorderControls = `
                        <div class="flex items-center gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            ${!isFirst ? `<button onclick="moveCategory('${category}', -1)" class="p-1 hover:bg-black/10 rounded text-current" title="Mover para cima"><i data-lucide="arrow-up" class="w-3 h-3"></i></button>` : ''}
                            ${!isLast ? `<button onclick="moveCategory('${category}', 1)" class="p-1 hover:bg-black/10 rounded text-current" title="Mover para baixo"><i data-lucide="arrow-down" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    `;
                }

                groupDiv.innerHTML = `
                    <div class="px-4 py-2 text-xs font-bold uppercase tracking-wider flex justify-between items-center ${headerClass} group">
                        <div class="flex items-center">
                            <span>${category}</span>
                            ${reorderControls}
                        </div>
                        <span class="opacity-60">${items.length} itens</span>
                    </div>
                    <div>${itemsHtml}</div>
                `;

                dom.itemsContainer.appendChild(groupDiv);
            });
        }

        function updateTheme() {
            const isShop = state.shopMode;
            const isDark = state.theme === 'dark';

            // Body
            dom.body.className = isDark 
                ? 'bg-gray-900 text-white min-h-screen transition-colors duration-500' 
                : 'bg-slate-50 text-slate-800 min-h-screen transition-colors duration-500';

            // Header
            dom.header.className = isDark
                ? 'px-6 py-4 flex justify-between items-center border-b border-gray-800 bg-gray-900 transition-colors duration-500'
                : 'px-6 py-4 flex justify-between items-center border-b bg-white border-slate-200 shadow-sm sticky top-0 z-10 transition-colors duration-500';

            // Back to Hub Button
            if (dom.backToHubBtn) {
                dom.backToHubBtn.className = isDark
                    ? 'hidden p-2 rounded-lg text-gray-400 hover:bg-gray-800 transition-colors mr-2' + (state.view === 'dashboard' ? ' block' : '')
                    : 'hidden p-2 rounded-lg text-slate-500 hover:bg-slate-100 transition-colors mr-2' + (state.view === 'dashboard' ? ' block' : '');
                
                if (state.view === 'dashboard') dom.backToHubBtn.classList.remove('hidden');
                else dom.backToHubBtn.classList.add('hidden');
            }

            // Logo Icon Bg
            if (isShop) {
                dom.logoIconBg.className = 'p-2 rounded-lg bg-shop-500 text-white transition-colors duration-500';
            } else {
                dom.logoIconBg.className = isDark 
                    ? 'p-2 rounded-lg bg-indigo-600 text-white transition-colors duration-500'
                    : 'p-2 rounded-lg bg-indigo-100 text-indigo-700 transition-colors duration-500';
            }

            // Logo Icon
            dom.logoIcon.setAttribute('data-lucide', isShop ? 'shopping-cart' : 'layout-dashboard');

            // Header Texts
            dom.modeText.textContent = isShop ? 'Modo Supermercado Ativo' : 'Dashboard de Planeamento';
            if (isShop) {
                dom.modeText.className = 'text-xs font-bold text-shop-500 uppercase tracking-wide';
            } else {
                dom.modeText.className = isDark ? 'text-xs text-gray-400' : 'text-xs text-slate-500';
            }

            // Theme Button Icon
            dom.themeBtn.innerHTML = `<i data-lucide="${state.theme === 'dark' ? 'sun' : 'moon'}" class="w-5 h-5"></i>`;
            
            dom.themeBtn.className = isDark
                ? 'p-2 rounded-full text-gray-400 hover:bg-gray-800 transition-colors'
                : 'p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors';

            // Toggle Button
            if (state.view === 'hub') {
                dom.toggleBtn.classList.add('hidden');
            } else {
                dom.toggleBtn.classList.remove('hidden');
                dom.toggleBtn.className = isShop 
                    ? 'flex items-center gap-2 px-4 py-2 rounded-full font-medium text-sm transition-all shadow-md bg-red-500 hover:bg-red-600 text-white'
                    : 'flex items-center gap-2 px-4 py-2 rounded-full font-medium text-sm transition-all shadow-md bg-indigo-600 hover:bg-indigo-700 text-white';
                dom.toggleBtn.innerHTML = isShop 
                    ? '<span>Sair do Modo Loja</span>' 
                    : '<i data-lucide="shopping-cart" class="w-4 h-4"></i><span>Ir √†s Compras</span>';
            }

            // Sort Dropdown Button Theme (Green Border in Shop Mode)
            const sortBtn = document.getElementById('sort-dropdown-btn');
            if (sortBtn) {
                if (isShop) {
                    sortBtn.className = isDark
                        ? 'w-full h-10 bg-gray-700 border-2 border-transparent hover:border-shop-400 focus:border-shop-400 focus:bg-gray-600 focus:outline-none rounded-lg px-4 text-sm text-gray-300 flex items-center justify-between transition-all'
                        : 'w-full h-10 bg-slate-50 border-2 border-transparent hover:border-shop-400 focus:border-shop-400 focus:bg-white focus:outline-none rounded-lg px-4 text-sm text-slate-600 flex items-center justify-between transition-all';
                } else {
                    sortBtn.className = isDark
                        ? 'w-full h-10 bg-gray-700 border-2 border-transparent hover:border-indigo-500 focus:border-indigo-500 focus:bg-gray-600 focus:outline-none rounded-lg px-4 text-sm text-gray-300 flex items-center justify-between transition-all'
                        : 'w-full h-10 bg-slate-50 border-2 border-transparent hover:border-indigo-300 focus:border-indigo-300 focus:bg-white focus:outline-none rounded-lg px-4 text-sm text-slate-600 flex items-center justify-between transition-all';
                }
            }

            // HUB THEME
            if (state.view === 'hub') {
                dom.hubTitle.className = isDark ? 'text-2xl font-bold text-white transition-colors' : 'text-2xl font-bold text-slate-800 transition-colors';
                dom.hubSubtitle.className = isDark ? 'text-gray-400 text-sm transition-colors' : 'text-slate-500 text-sm transition-colors';
                
                // Re-render hub to apply card themes
                renderHub();
            }

            // Sidebar Visibility
            if (isShop) {
                dom.sidebar.classList.add('hidden');
                dom.mainSection.classList.remove('lg:col-span-8');
                dom.mainSection.classList.add('lg:col-span-12', 'max-w-2xl', 'mx-auto', 'w-full');
                
                // Hide Action Bar in Shop Mode
                const actionBar = document.getElementById('action-bar');
                if(actionBar) actionBar.classList.add('hidden');

                dom.shopFooter.classList.remove('hidden', 'translate-y-full');
                
                // Shop Footer Theme
                dom.shopFooter.className = isDark
                    ? 'fixed bottom-0 left-0 w-full bg-gray-900 border-t border-gray-800 p-4 shadow-lg z-20 transition-transform duration-300'
                    : 'fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4 shadow-lg z-20 transition-transform duration-300';
                
                // Update Footer Total Color
                if(dom.footerTotal) dom.footerTotal.className = 'text-2xl font-bold font-mono text-shop-400';
                
                // Update Finish Button Color
                if(dom.finishShopBtn) dom.finishShopBtn.className = 'bg-shop-600 hover:bg-shop-700 text-white px-6 py-3 rounded-full font-bold shadow-lg transition-colors flex items-center gap-2';

            } else {
                dom.sidebar.classList.remove('hidden');
                dom.mainSection.classList.add('lg:col-span-8');
                dom.mainSection.classList.remove('lg:col-span-12', 'max-w-2xl', 'mx-auto', 'w-full');
                
                // Show Action Bar
                const actionBar = document.getElementById('action-bar');
                if(actionBar) actionBar.classList.remove('hidden');

                dom.shopFooter.classList.add('hidden', 'translate-y-full');
            }

            // Update Budget Card Theme
            if (dom.budgetCard) {
                dom.budgetCard.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-sm border border-slate-100 transition-colors duration-500';
                
                const budgetTitle = dom.budgetCard.querySelector('h2');
                if(budgetTitle) budgetTitle.className = isDark ? 'text-sm font-semibold text-gray-500 uppercase tracking-wider' : 'text-sm font-semibold text-slate-400 uppercase tracking-wider';
                
                const budgetValue = document.getElementById('budget-display');
                if(budgetValue) budgetValue.className = isDark ? 'text-3xl font-bold text-white mt-1 transition-colors duration-500' : 'text-3xl font-bold text-slate-800 mt-1 transition-colors duration-500';
            
                // Progress Bar Container Theme
                if (dom.progressBarContainer) {
                    dom.progressBarContainer.className = isDark
                        ? 'w-full bg-gray-700 rounded-full h-3 mb-2 overflow-hidden transition-colors duration-500'
                        : 'w-full bg-slate-100 rounded-full h-3 mb-2 overflow-hidden transition-colors duration-500';
                }
            }

            // Update Add Item Modal Theme
            if (dom.addItemModalContent) {
                dom.addItemModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.addItemModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                let inputClass = '';
                if (isShop) {
                    inputClass = isDark
                        ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-shop-500 rounded-lg text-sm transition-all text-white placeholder-gray-400 font-medium'
                        : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-shop-400 rounded-lg text-sm transition-all font-medium';
                } else {
                    inputClass = isDark
                        ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg text-sm transition-all text-white placeholder-gray-400 font-medium'
                        : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm transition-all font-medium';
                }
                
                dom.inputName.className = `${inputClass} pl-9`;
                
                // Update Search Icon in Modal
                const searchIcon = dom.inputName.parentElement.querySelector('i');
                if (searchIcon) {
                    if (isShop) {
                        searchIcon.className = 'h-4 w-4 text-slate-400 group-focus-within:text-shop-500 transition-colors';
                    } else {
                        searchIcon.className = 'h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors';
                    }
                }

                dom.inputQuantity.className = `${inputClass} px-3`;
                dom.inputPrice.className = `${inputClass} pl-8`;
                
                // Unit Dropdown Theme
                if (dom.unitDropdownBtn) {
                    if (isShop) {
                        dom.unitDropdownBtn.className = isDark
                            ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-shop-500 rounded-lg px-2 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                            : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-shop-400 rounded-lg px-2 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    } else {
                        dom.unitDropdownBtn.className = isDark
                            ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                            : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-2 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    }
                    
                    dom.unitDropdownMenu.className = isDark
                        ? 'hidden absolute top-full right-0 w-24 mt-2 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-20 max-h-60 overflow-y-auto'
                        : 'hidden absolute top-full right-0 w-24 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto';
                }

                const labels = dom.addItemModalContent.querySelectorAll('label');
                labels.forEach(label => {
                    label.className = isDark ? 'block text-xs font-medium text-gray-400 mb-1' : 'block text-xs font-medium text-slate-500 mb-1';
                });

                if (isShop) {
                    dom.addBtn.className = 'px-4 py-2 rounded-lg bg-shop-600 hover:bg-shop-700 text-white font-medium transition-colors flex items-center gap-2';
                } else {
                    dom.addBtn.className = 'px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors flex items-center gap-2';
                }

                dom.cancelAddBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
                
                // Custom Dropdown Theme inside Modal
                if (dom.categoryDropdownBtn) {
                    if (isShop) {
                        dom.categoryDropdownBtn.className = isDark
                            ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-shop-500 rounded-lg px-3 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                            : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-shop-400 rounded-lg px-3 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    } else {
                        dom.categoryDropdownBtn.className = isDark
                            ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-3 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                            : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-3 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    }
                    
                    dom.categoryDropdownMenu.className = isDark
                        ? 'hidden absolute top-full left-0 w-full mt-2 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-20 max-h-60 overflow-y-auto'
                        : 'hidden absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto';
                }
            }

            // Update Search Bar Theme
            if (dom.searchInput) {
                dom.searchInput.className = isDark
                    ? 'w-full h-12 pl-10 bg-gray-800 border border-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-900 rounded-xl text-sm transition-all font-medium shadow-sm text-white placeholder-gray-500'
                    : 'w-full h-12 pl-10 bg-white border border-slate-100 focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 rounded-xl text-sm transition-all font-medium shadow-sm';
                
                if (dom.openAddModalBtn) {
                    if (isShop) {
                        dom.openAddModalBtn.className = 'h-10 px-4 bg-shop-600 hover:bg-shop-700 text-white rounded-lg flex items-center justify-center gap-2 transition-all shadow-md hover:scale-105 active:scale-95';
                    } else {
                        dom.openAddModalBtn.className = isDark
                            ? 'h-10 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center justify-center gap-2 transition-all shadow-md shadow-indigo-900/50 hover:scale-105 active:scale-95'
                            : 'h-10 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg flex items-center justify-center gap-2 transition-all shadow-md shadow-indigo-200 hover:shadow-indigo-300 hover:scale-105 active:scale-95';
                    }
                }
            }

            // Update Modal Theme
            if (dom.deleteModalContent) {
                dom.deleteModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.deleteModalTitle.className = isDark ? 'text-lg font-bold text-white mb-2 transition-colors' : 'text-lg font-bold text-slate-800 mb-2 transition-colors';
                dom.deleteModalText.className = isDark ? 'text-gray-400 mb-6 transition-colors' : 'text-slate-500 mb-6 transition-colors';
                
                dom.cancelDeleteBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Edit Modal Theme
            if (dom.editModalContent) {
                dom.editModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.editModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                const inputClass = isDark
                    ? 'w-full bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-4 py-2 text-sm transition-all text-white placeholder-gray-400'
                    : 'w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all';
                
                dom.editNameInput.className = inputClass;
                dom.editPriceInput.className = inputClass;
                dom.editQuantityInput.className = inputClass;

                // Edit Category Dropdown Theme
                if (dom.editCategoryDropdownBtn) {
                    dom.editCategoryDropdownBtn.className = isDark
                        ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-3 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                        : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-3 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    
                    dom.editCategoryDropdownMenu.className = isDark
                        ? 'hidden absolute top-full left-0 w-full mt-2 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-20 max-h-60 overflow-y-auto'
                        : 'hidden absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto';
                }

                // Edit Unit Dropdown Theme
                if (dom.editUnitDropdownBtn) {
                    dom.editUnitDropdownBtn.className = isDark
                        ? 'w-full h-10 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-2 text-sm text-gray-300 flex items-center justify-between transition-all font-medium'
                        : 'w-full h-10 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-2 text-sm text-slate-600 flex items-center justify-between transition-all font-medium';
                    
                    dom.editUnitDropdownMenu.className = isDark
                        ? 'hidden absolute top-full right-0 w-24 mt-2 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-20 max-h-60 overflow-y-auto'
                        : 'hidden absolute top-full right-0 w-24 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 max-h-60 overflow-y-auto';
                }

                const labels = dom.editModalContent.querySelectorAll('label');
                labels.forEach(label => {
                    label.className = isDark ? 'block text-xs font-medium text-gray-400 mb-1' : 'block text-xs font-medium text-slate-500 mb-1';
                });

                dom.cancelEditBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Category Modal Theme
            if (dom.addCategoryModalContent) {
                dom.addCategoryModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.addCategoryModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                dom.newCategoryInput.className = isDark
                    ? 'w-full bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-4 py-2 text-sm mb-6 transition-all text-white placeholder-gray-400'
                    : 'w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm mb-6 transition-all';

                dom.cancelCategoryBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Finish Modal Theme
            if (dom.finishModalContent) {
                dom.finishModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.finishModalTitle.className = isDark ? 'text-lg font-bold text-white mb-2 transition-colors' : 'text-lg font-bold text-slate-800 mb-2 transition-colors';
                dom.finishModalText.className = isDark ? 'text-gray-400 mb-6 transition-colors' : 'text-slate-500 mb-6 transition-colors';
                
                dom.cancelFinishBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Delete Suggestion Modal Theme
            if (dom.deleteSuggestionModalContent) {
                dom.deleteSuggestionModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.deleteSuggestionModalTitle.className = isDark ? 'text-lg font-bold text-white mb-2 transition-colors' : 'text-lg font-bold text-slate-800 mb-2 transition-colors';
                dom.deleteSuggestionModalText.className = isDark ? 'text-gray-400 mb-6 transition-colors' : 'text-slate-500 mb-6 transition-colors';
                
                dom.cancelDeleteSuggestionBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Settings Modal Theme
            if (dom.settingsModalContent) {
                dom.settingsModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.settingsModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                const inputClass = isDark
                    ? 'w-full bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-4 py-2 text-sm transition-all text-white placeholder-gray-400'
                    : 'w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all';
                
                dom.settingsAppName.className = inputClass;

                dom.labelAppName.className = isDark ? 'block text-xs font-bold text-gray-500 uppercase mb-1' : 'block text-xs font-bold text-slate-400 uppercase mb-1';
                dom.settingsRoundLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';
                dom.settingsSuggestionsLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';

                // Confirmations Theme
                if (dom.settingsConfirmationsTitle) dom.settingsConfirmationsTitle.className = isDark ? 'text-xs font-bold text-gray-500 uppercase mb-3' : 'text-xs font-bold text-slate-400 uppercase mb-3';
                if (dom.settingsConfirmBudgetLabel) dom.settingsConfirmBudgetLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';
                if (dom.settingsConfirmItemLabel) dom.settingsConfirmItemLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';
                if (dom.settingsConfirmSuggestionLabel) dom.settingsConfirmSuggestionLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';
                if (dom.settingsConfirmFinishLabel) dom.settingsConfirmFinishLabel.className = isDark ? 'text-sm font-medium text-gray-300 transition-colors' : 'text-sm font-medium text-slate-600 transition-colors';
                
                const divider = document.getElementById('settings-confirmations-divider');
                if(divider) divider.className = isDark ? 'pt-4 border-t border-gray-700' : 'pt-4 border-t border-slate-100';

                // Update toggle theme
                try {
                    updateSettingsToggleUI(state.roundValues);
                    updateSuggestionsToggleUI(state.enableSuggestions);
                    updateConfirmToggleUI('budget', state.confirmDeleteBudget);
                    updateConfirmToggleUI('item', state.confirmDeleteItem);
                    updateConfirmToggleUI('suggestion', state.confirmDeleteSuggestion);
                    updateConfirmToggleUI('finish', state.confirmFinishShop);
                } catch(e) { console.error(e); }

                dom.cancelSettingsBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Budget Settings Modal Theme
            const budgetModalContent = document.getElementById('budget-settings-content');
            if (budgetModalContent) {
                const title = budgetModalContent.querySelector('h3');
                const labels = budgetModalContent.querySelectorAll('label');
                const inputs = budgetModalContent.querySelectorAll('input');
                const cancelBtn = document.getElementById('cancel-budget-settings');
                const closeBtn = document.getElementById('close-budget-settings-modal');
                const currencySpan = budgetModalContent.querySelector('.relative span');

                budgetModalContent.className = isDark
                    ? 'bg-gray-800 rounded-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl border border-gray-700'
                    : 'bg-white rounded-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300 shadow-2xl';
                
                if(title) title.className = isDark ? 'text-xl font-bold text-white' : 'text-xl font-bold text-slate-800';
                
                if(closeBtn) closeBtn.className = isDark 
                    ? 'text-gray-400 hover:text-white transition-colors'
                    : 'text-slate-400 hover:text-slate-600 transition-colors';

                if(currencySpan) currencySpan.className = isDark
                    ? 'absolute left-4 top-1/2 -translate-y-1/2 text-gray-400'
                    : 'absolute left-4 top-1/2 -translate-y-1/2 text-slate-400';

                labels.forEach(l => l.className = isDark 
                    ? 'block text-sm font-medium text-gray-300 mb-1'
                    : 'block text-sm font-medium text-slate-600 mb-1');

                inputs.forEach(i => i.className = isDark
                    ? 'w-full px-4 h-10 rounded-xl border border-gray-600 bg-gray-700 text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-900 outline-none transition-all' + (i.id === 'budget-limit-input' ? ' pl-10' : '')
                    : 'w-full px-4 h-10 rounded-xl border border-slate-200 bg-white text-slate-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all' + (i.id === 'budget-limit-input' ? ' pl-10' : ''));

                if(cancelBtn) cancelBtn.className = isDark
                    ? 'flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 font-medium hover:bg-gray-700 transition-colors'
                    : 'flex-1 px-4 py-2 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors';
            }

            // Update Tutorial Modal Theme
            if (dom.tutorialModalContent) {
                dom.tutorialModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-gray-700 transition-colors duration-500 max-h-[80vh] overflow-y-auto'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[80vh] overflow-y-auto';
                
                dom.tutorialModalTitle.className = isDark ? 'text-xl font-bold text-white transition-colors' : 'text-xl font-bold text-slate-800 transition-colors';
                dom.tutorialModalText.className = isDark ? 'space-y-4 text-gray-300 text-sm transition-colors' : 'space-y-4 text-slate-600 text-sm transition-colors';
                
                dom.closeTutorialBtn.className = isDark
                    ? 'p-1 rounded-lg hover:bg-gray-700 text-gray-400 transition-colors'
                    : 'p-1 rounded-lg hover:bg-slate-100 text-slate-400 transition-colors';

                const headings = dom.tutorialModalText.querySelectorAll('.tutorial-heading');
                headings.forEach(h => {
                    h.className = isDark ? 'font-bold text-white mb-1 tutorial-heading' : 'font-bold text-slate-800 mb-1 tutorial-heading';
                });
            }

            // Update New Budget Modal Theme
            if (dom.newBudgetModalContent) {
                dom.newBudgetModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.newBudgetModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                const inputClass = isDark
                    ? 'w-full bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-4 py-2 text-sm transition-all text-white placeholder-gray-400'
                    : 'w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all';
                
                dom.newBudgetName.className = inputClass;
                dom.newBudgetLimit.className = inputClass;

                const labelClass = isDark ? 'block text-xs font-bold text-gray-500 uppercase mb-1' : 'block text-xs font-bold text-slate-400 uppercase mb-1';
                document.getElementById('new-budget-name-label').className = labelClass;
                document.getElementById('new-budget-limit-label').className = labelClass;

                dom.cancelNewBudgetBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Edit Hub Budget Modal Theme
            if (dom.editHubBudgetModalContent) {
                dom.editHubBudgetModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.editHubBudgetModalTitle.className = isDark ? 'text-lg font-bold text-white mb-4 transition-colors' : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
                
                const inputClass = isDark
                    ? 'w-full bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg px-4 py-2 text-sm transition-all text-white placeholder-gray-400'
                    : 'w-full bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg px-4 py-2 text-sm transition-all';
                
                dom.editHubBudgetName.className = inputClass;
                dom.editHubBudgetLimit.className = inputClass;

                const labelClass = isDark ? 'block text-xs font-bold text-gray-500 uppercase mb-1' : 'block text-xs font-bold text-slate-400 uppercase mb-1';
                document.getElementById('edit-hub-budget-name-label').className = labelClass;
                document.getElementById('edit-hub-budget-limit-label').className = labelClass;

                dom.cancelEditHubBudgetBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Delete Budget Modal Theme
            if (dom.deleteBudgetModalContent) {
                dom.deleteBudgetModalContent.className = isDark
                    ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-gray-700 transition-colors duration-500'
                    : 'bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 border border-slate-100 transition-colors duration-500';
                
                dom.deleteBudgetModalTitle.className = isDark ? 'text-lg font-bold text-white mb-2 transition-colors' : 'text-lg font-bold text-slate-800 mb-2 transition-colors';
                dom.deleteBudgetModalText.className = isDark ? 'text-gray-400 mb-6 transition-colors' : 'text-slate-500 mb-6 transition-colors';
                
                dom.cancelDeleteBudgetBtn.className = isDark
                    ? 'px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 font-medium transition-colors'
                    : 'px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-colors';
            }

            // Update Sort Dropdown Theme
            const sortMenu = document.getElementById('sort-dropdown-menu');

            if (sortMenu) {
                sortMenu.className = isDark
                    ? 'hidden absolute top-full right-0 w-full mt-1 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-20'
                    : 'hidden absolute top-full right-0 w-full mt-1 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20';
                
                const options = sortMenu.querySelectorAll('div');
                options.forEach(opt => {
                    opt.className = isDark
                        ? 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm text-gray-300 transition-colors'
                        : 'px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-600 transition-colors';
                });
            }
        }

        // --- HANDLERS ---
        
        let deleteType = null; // 'item' | 'category'
        let deleteTarget = null; // id (for item) | categoryName (for category)

        function openDeleteModal(id) {
            deleteType = 'item';
            deleteTarget = id;
            
            if (!state.confirmDeleteItem) {
                confirmDelete();
                return;
            }

            dom.deleteModalTitle.textContent = 'Remover Item?';
            dom.deleteModalText.textContent = 'Tem certeza que deseja remover este item da lista?';
            dom.deleteModal.classList.remove('hidden');
        }

        function openDeleteCategoryModal(categoryName) {
            deleteType = 'category';
            deleteTarget = categoryName;
            
            if (!state.confirmDeleteItem) {
                confirmDelete();
                return;
            }

            const itemsInCategory = state.items.filter(i => i.category === categoryName);
            const count = itemsInCategory.length;

            dom.deleteModalTitle.textContent = 'Excluir Categoria?';
            
            if (count > 0) {
                dom.deleteModalText.innerHTML = `Esta categoria possui <strong class="text-red-500">${count} item(ns)</strong>.<br>Ao excluir, ela e todos os seus itens ser√£o removidos.`;
            } else {
                dom.deleteModalText.textContent = `Tem certeza que deseja excluir a categoria "${categoryName}"?`;
            }
            
            dom.deleteModal.classList.remove('hidden');
        }

        function openEditModal(id) {
            const item = state.items.find(i => i.id === id);
            if (!item) return;

            state.editingItemId = id;
            dom.editNameInput.value = item.name;
            dom.editPriceInput.value = item.price || '';
            dom.editQuantityInput.value = item.quantity || 1;
            
            // Set initial values for hidden inputs
            dom.editCategorySelect.value = item.category || 'Geral';
            dom.editUnitInput.value = item.unit || 'un';

            // Render dropdowns
            renderEditCategories();
            renderEditUnitDropdown();

            dom.editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            state.editingItemId = null;
            dom.editModal.classList.add('hidden');
        }

        async function saveEdit() {
            if (!state.editingItemId) return;

            let name = dom.editNameInput.value.trim();
            if (name.length > 0) {
                name = name.charAt(0).toUpperCase() + name.slice(1);
            }
            
            const price = parseFloat(dom.editPriceInput.value) || 0;
            const quantity = parseInt(dom.editQuantityInput.value) || 1;
            const unit = dom.editUnitInput.value || 'un';
            const category = dom.editCategorySelect.value;

            if (!name) return;

            const itemIndex = state.items.findIndex(i => i.id === state.editingItemId);
            if (itemIndex !== -1) {
                const idToUpdate = state.editingItemId; // Capture ID before closing modal
                const updatedItem = { ...state.items[itemIndex], name, price, quantity, unit, category };
                
                // Optimistic update
                state.items[itemIndex] = updatedItem;
                syncLocalState();
                renderAll();
                closeEditModal();

                // API update
                await apiService.updateItem(idToUpdate, updatedItem);
            }
        }

        let suggestionToDeleteId = null;

        function openDeleteSuggestionModal(id) {
            suggestionToDeleteId = id;
            
            if (!state.confirmDeleteSuggestion) {
                confirmDeleteSuggestion();
                return;
            }

            dom.deleteSuggestionModal.classList.remove('hidden');
        }

        function closeDeleteSuggestionModal() {
            suggestionToDeleteId = null;
            dom.deleteSuggestionModal.classList.add('hidden');
        }

        async function confirmDeleteSuggestion() {
            if (suggestionToDeleteId) {
                const id = suggestionToDeleteId;
                closeDeleteSuggestionModal();
                await performDeleteSuggestion(id);
            }
        }

        async function performDeleteSuggestion(id) {
            if (!id) return;

            // Optimistic update
            state.products = state.products.filter(p => p._id !== id);
            
            // Re-render suggestions if input still has value
            const val = dom.inputName.value;
            if (val.length > 0) {
                const matches = state.products.filter(p => p.name.toLowerCase().startsWith(val.toLowerCase()));
                showSuggestions(matches);
            } else {
                hideSuggestions();
            }

            await apiService.deleteProduct(id);
        }

        function closeDeleteModal() {
            deleteType = null;
            deleteTarget = null;
            dom.deleteModal.classList.add('hidden');
        }

        function openAddCategoryModal() {
            dom.newCategoryInput.value = '';
            dom.addCategoryModal.classList.remove('hidden');
            dom.newCategoryInput.focus();
        }

        function closeAddCategoryModal() {
            dom.addCategoryModal.classList.add('hidden');
            // Reset select to Geral if cancelled
            if (dom.inputCategory.value === '__new__') {
                dom.inputCategory.value = 'Geral';
            }
        }

        function confirmAddCategory() {
            const newCat = dom.newCategoryInput.value.trim();
            if (newCat) {
                dom.addCategoryModal.classList.add('hidden'); // Close manually to avoid reset logic
                if (!state.categories.includes(newCat)) {
                    state.categories.push(newCat);
                    saveActiveBudgetMetadata();
                }
                renderCategories();
                selectCategory(newCat, false);
            } else {
                closeAddCategoryModal();
            }
        }

        function openFinishModal() {
            if (!state.confirmFinishShop) {
                confirmFinishShopping();
                return;
            }
            dom.finishModal.classList.remove('hidden');
        }

        function closeFinishModal() {
            dom.finishModal.classList.add('hidden');
        }

        function openTutorialModal() {
            dom.tutorialModal.classList.remove('hidden');
        }

        function closeTutorialModal() {
            dom.tutorialModal.classList.add('hidden');
        }

        function openSettingsModal() {
            dom.settingsAppName.value = state.appName;
            
            // Safely update toggles
            try {
                updateSettingsToggleUI(state.roundValues);
                updateSuggestionsToggleUI(state.enableSuggestions);
                updateConfirmToggleUI('budget', state.confirmDeleteBudget);
                updateConfirmToggleUI('item', state.confirmDeleteItem);
                updateConfirmToggleUI('suggestion', state.confirmDeleteSuggestion);
                updateConfirmToggleUI('finish', state.confirmFinishShop);
            } catch (e) {
                console.error('Error updating settings UI:', e);
            }
            
            dom.settingsModal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            dom.settingsModal.classList.add('hidden');
        }

        function toggleSettingsRound() {
            state.roundValues = !state.roundValues;
            updateSettingsToggleUI(state.roundValues);
        }

        function toggleConfirm(key) {
            if (key === 'budget') state.confirmDeleteBudget = !state.confirmDeleteBudget;
            if (key === 'item') state.confirmDeleteItem = !state.confirmDeleteItem;
            if (key === 'suggestion') state.confirmDeleteSuggestion = !state.confirmDeleteSuggestion;
            if (key === 'finish') state.confirmFinishShop = !state.confirmFinishShop;
            
            const val = key === 'budget' ? state.confirmDeleteBudget :
                       key === 'item' ? state.confirmDeleteItem :
                       key === 'suggestion' ? state.confirmDeleteSuggestion :
                       state.confirmFinishShop;
                       
            updateConfirmToggleUI(key, val);
        }

        function updateConfirmToggleUI(key, isChecked) {
            const isDark = state.theme === 'dark';
            const uncheckedBg = isDark ? 'bg-gray-600' : 'bg-slate-200';
            
            let toggle, knob;
            // Re-fetch elements to be safe
            if (key === 'budget') { 
                toggle = document.getElementById('settings-confirm-budget-toggle'); 
                knob = document.getElementById('settings-confirm-budget-knob'); 
            }
            if (key === 'item') { 
                toggle = document.getElementById('settings-confirm-item-toggle'); 
                knob = document.getElementById('settings-confirm-item-knob'); 
            }
            if (key === 'suggestion') { 
                toggle = document.getElementById('settings-confirm-suggestion-toggle'); 
                knob = document.getElementById('settings-confirm-suggestion-knob'); 
            }
            if (key === 'finish') { 
                toggle = document.getElementById('settings-confirm-finish-toggle'); 
                knob = document.getElementById('settings-confirm-finish-knob'); 
            }

            if (toggle && knob) {
                if (isChecked) {
                    toggle.classList.remove('bg-slate-200', 'bg-gray-600');
                    toggle.classList.add('bg-indigo-600');
                    knob.classList.add('translate-x-6');
                } else {
                    toggle.classList.remove('bg-indigo-600', 'bg-slate-200', 'bg-gray-600');
                    toggle.classList.add(uncheckedBg);
                    knob.classList.remove('translate-x-6');
                }
            }
        }

        function updateSettingsToggleUI(isChecked) {
            const isDark = state.theme === 'dark';
            const uncheckedBg = isDark ? 'bg-gray-600' : 'bg-slate-200';

            if (isChecked) {
                dom.settingsRoundToggle.classList.remove('bg-slate-200', 'bg-gray-600');
                dom.settingsRoundToggle.classList.add('bg-indigo-600');
                dom.settingsRoundKnob.classList.add('translate-x-6');
            } else {
                dom.settingsRoundToggle.classList.remove('bg-indigo-600', 'bg-slate-200', 'bg-gray-600');
                dom.settingsRoundToggle.classList.add(uncheckedBg);
                dom.settingsRoundKnob.classList.remove('translate-x-6');
            }
        }

        function toggleSettingsSuggestions() {
            state.enableSuggestions = !state.enableSuggestions;
            updateSuggestionsToggleUI(state.enableSuggestions);
        }

        function updateSuggestionsToggleUI(isChecked) {
            const isDark = state.theme === 'dark';
            const uncheckedBg = isDark ? 'bg-gray-600' : 'bg-slate-200';

            if (isChecked) {
                dom.settingsSuggestionsToggle.classList.remove('bg-slate-200', 'bg-gray-600');
                dom.settingsSuggestionsToggle.classList.add('bg-indigo-600');
                dom.settingsSuggestionsKnob.classList.add('translate-x-6');
            } else {
                dom.settingsSuggestionsToggle.classList.remove('bg-indigo-600', 'bg-slate-200', 'bg-gray-600');
                dom.settingsSuggestionsToggle.classList.add(uncheckedBg);
                dom.settingsSuggestionsKnob.classList.remove('translate-x-6');
            }
        }

        function showSuggestions(matches) {
            const dropdown = dom.suggestionsDropdown;
            if (!matches.length) {
                dropdown.classList.add('hidden');
                return;
            }

            const isDark = state.theme === 'dark';
            dropdown.className = isDark 
                ? 'absolute top-full left-0 w-full mt-2 bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden z-30 max-h-60 overflow-y-auto'
                : 'absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-30 max-h-60 overflow-y-auto';

            dropdown.innerHTML = '';
            
            matches.forEach(p => {
                const div = document.createElement('div');
                div.className = isDark
                    ? 'px-4 py-3 hover:bg-gray-700 cursor-pointer flex justify-between items-center border-b border-gray-700 last:border-0 transition-colors group'
                    : 'px-4 py-3 hover:bg-slate-50 cursor-pointer flex justify-between items-center border-b border-slate-50 last:border-0 transition-colors group';
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <span class="${isDark ? 'text-gray-200' : 'text-slate-700'} font-medium truncate">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="${isDark ? 'text-indigo-400' : 'text-indigo-600'} text-sm font-bold whitespace-nowrap">R$ ${p.price.toFixed(2)}</span>
                        <button class="delete-suggestion-btn p-1.5 rounded-lg hover:bg-red-100 text-slate-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" title="Remover sugest√£o">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                const deleteBtn = div.querySelector('.delete-suggestion-btn');
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    openDeleteSuggestionModal(p._id);
                };

                div.onclick = () => selectSuggestion(p);
                dropdown.appendChild(div);
            });

            lucide.createIcons();
            dropdown.classList.remove('hidden');
        }



        function hideSuggestions() {
            dom.suggestionsDropdown.classList.add('hidden');
        }

        function selectSuggestion(product) {
            dom.inputName.value = product.name;
            dom.inputPrice.value = product.price.toFixed(2);
            hideSuggestions();
            dom.inputQuantity.focus();
        }

        function saveSettings() {
            closeSettingsModal();
            state.appName = dom.settingsAppName.value.trim() || 'LionsDash';
            state.roundValues = dom.settingsRoundToggle.classList.contains('bg-indigo-600');
            
            renderAll();
        }

        async function confirmFinishShopping() {
            closeFinishModal();
            const itemsToDelete = state.items.filter(i => i.checked);
            
            // Optimistic update
            state.items = state.items.filter(i => !i.checked);
            
            // Turn off Shop Mode automatically
            state.shopMode = false;

            syncLocalState();
            renderAll();

            // Sync with API
            for (const item of itemsToDelete) {
                await apiService.deleteItem(item.id);
            }
        }

        async function confirmDelete() {
            if (deleteType === 'item' && deleteTarget) {
                const id = deleteTarget;
                closeDeleteModal();
                state.items = state.items.filter(i => i.id !== id);
                syncLocalState();
                renderAll();
                await apiService.deleteItem(id);
            } else if (deleteType === 'category' && deleteTarget) {
                const categoryName = deleteTarget;
                closeDeleteModal();
                
                // Identify items to delete
                const itemsToDelete = state.items.filter(i => i.category === categoryName);

                // Remove items locally
                state.items = state.items.filter(i => i.category !== categoryName);

                // Remove category locally
                state.categories = state.categories.filter(c => c !== categoryName);
                
                // Reset input if selected
                if (dom.inputCategory.value === categoryName) {
                    selectCategory('Geral', false);
                }

                syncLocalState();
                saveActiveBudgetMetadata(); // Updates categories on API
                renderCategories(); 
                renderAll();

                // Delete category on API (which also deletes items)
                await apiService.deleteCategory(state.activeBudgetId, categoryName);
            }
        }

        async function handleAdd(e) {
            if(e) e.preventDefault();
            
            // Prote√ß√£o contra m√∫ltiplos cliques
            if (dom.addBtn.disabled) return;

            const originalBtnContent = dom.addBtn.innerHTML;
            dom.addBtn.disabled = true;
            dom.addBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>';

            try {
                let name = dom.inputName.value.trim();
                if (name.length > 0) {
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                }

                const price = parseFloat(dom.inputPrice.value) || 0;
                const quantity = parseInt(dom.inputQuantity.value) || 1;
                const unit = document.getElementById('input-unit').value || 'un';
                const category = dom.inputCategory.value;

                if (!name) {
                    dom.addBtn.disabled = false;
                    dom.addBtn.innerHTML = originalBtnContent;
                    return;
                }

                const tempItem = {
                    name,
                    price,
                    quantity,
                    unit,
                    category,
                    checked: false
                };

                // Adiciona localmente para feedback instant√¢neo (Optimistic UI)
                // state.items.push({...tempItem, id: Date.now()}); 
                // renderAll();

                // Ou espera API
                const newItem = await apiService.addItem(tempItem);
                state.items.push(newItem);
                syncLocalState();

                // Save product for future suggestions
                if (!state.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    const newProd = { name, price };
                    const res = await apiService.createProduct(newProd);
                    if (res && res.product) {
                        state.products.push(res.product);
                    }
                }
                
                // Limpar form e fechar modal
                dom.inputName.value = '';
                dom.inputPrice.value = '';
                dom.inputQuantity.value = '';
                closeAddModal();
                
                renderAll();
            } catch (error) {
                console.error("Erro ao adicionar item:", error);
            } finally {
                dom.addBtn.disabled = false;
                dom.addBtn.innerHTML = originalBtnContent;
            }
        }

        function openAddModal() {
            dom.addItemModal.classList.remove('hidden');
            renderCategories();
            renderUnitDropdown();
            dom.inputName.focus();
        }

        function closeAddModal() {
            dom.addItemModal.classList.add('hidden');
        }

        async function handleToggle(id) {
            const item = state.items.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                syncLocalState();
                renderAll(); // Atualiza UI instantaneamente
                await apiService.toggleItem(id, item.checked); // Sincroniza fundo
            }
        }

        async function handleDelete(id, e) {
            if (e) e.stopPropagation();
            openDeleteModal(id);
        }

        function toggleShopMode() {
            state.shopMode = !state.shopMode;
            
            // Toggle Share Button
            const shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                if (state.shopMode) {
                    shareBtn.classList.add('hidden');
                } else {
                    shareBtn.classList.remove('hidden');
                }
            }

            renderAll();
        }

        function shareList() {
            const itemsToBuy = state.items.filter(i => !i.checked);
            if (itemsToBuy.length === 0) {
                alert('Sua lista de compras est√° vazia ou tudo j√° foi marcado!');
                return;
            }

            let text = `*Lista de Compras - ${state.budgetTitle}*\n\n`;
            
            // Group by category for nicer output
            const groups = {};
            itemsToBuy.forEach(item => {
                if (!groups[item.category]) groups[item.category] = [];
                groups[item.category].push(item);
            });

            for (const [cat, items] of Object.entries(groups)) {
                text += `*${cat}*\n`;
                items.forEach(item => {
                    const unit = item.unit && item.unit !== 'un' ? item.unit : '';
                    const qty = item.quantity || 1;
                    text += `- [ ] ${qty}${unit} ${item.name}\n`;
                });
                text += '\n';
            }

            text += `_Gerado por LionsDash_`;

            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function moveCategory(category, direction) {
            const index = state.categories.indexOf(category);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= state.categories.length) return;

            // Swap
            const temp = state.categories[index];
            state.categories[index] = state.categories[newIndex];
            state.categories[newIndex] = temp;

            saveActiveBudgetMetadata();
            renderAll();
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            renderAll();
        }

        // --- EVENT LISTENERS ---

        dom.inputCategory.addEventListener('change', (e) => {
            // Legacy listener removed
        });

        // Dropdown Listeners
        dom.categoryDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleCategoryDropdown();
        });

        if (dom.unitDropdownBtn) {
            dom.unitDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleUnitDropdown();
            });
        }

        // Edit Modal Dropdown Listeners
        if (dom.editCategoryDropdownBtn) {
            dom.editCategoryDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleEditCategoryDropdown();
            });
        }

        if (dom.editUnitDropdownBtn) {
            dom.editUnitDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleEditUnitDropdown();
            });
        }

        document.addEventListener('click', (e) => {
            // Category Dropdown
            if (!dom.categoryDropdownBtn.contains(e.target) && !dom.categoryDropdownMenu.contains(e.target)) {
                if (!dom.categoryDropdownMenu.classList.contains('hidden')) {
                    toggleCategoryDropdown();
                }
            }

            // Unit Dropdown
            if (dom.unitDropdownBtn && dom.unitDropdownMenu && !dom.unitDropdownBtn.contains(e.target) && !dom.unitDropdownMenu.contains(e.target)) {
                if (!dom.unitDropdownMenu.classList.contains('hidden')) {
                    toggleUnitDropdown();
                }
            }

            // Edit Category Dropdown
            if (dom.editCategoryDropdownBtn && dom.editCategoryDropdownMenu && !dom.editCategoryDropdownBtn.contains(e.target) && !dom.editCategoryDropdownMenu.contains(e.target)) {
                if (!dom.editCategoryDropdownMenu.classList.contains('hidden')) {
                    toggleEditCategoryDropdown();
                }
            }

            // Edit Unit Dropdown
            if (dom.editUnitDropdownBtn && dom.editUnitDropdownMenu && !dom.editUnitDropdownBtn.contains(e.target) && !dom.editUnitDropdownMenu.contains(e.target)) {
                if (!dom.editUnitDropdownMenu.classList.contains('hidden')) {
                    toggleEditUnitDropdown();
                }
            }
            
            // Sort Dropdown
            const sortBtn = document.getElementById('sort-dropdown-btn');
            const sortMenu = document.getElementById('sort-dropdown-menu');
            if (sortBtn && sortMenu && !sortBtn.contains(e.target) && !sortMenu.contains(e.target)) {
                if (!sortMenu.classList.contains('hidden')) {
                    toggleSortDropdown();
                }
            }
        });

        // Add Modal Listeners
        dom.openAddModalBtn.addEventListener('click', openAddModal);
        dom.cancelAddBtn.addEventListener('click', closeAddModal);
        dom.addItemModal.addEventListener('click', (e) => {
            if (e.target === dom.addItemModal) closeAddModal();
        });

        // Search Listener
        dom.searchInput.addEventListener('input', (e) => {
            state.searchTerm = e.target.value;
            renderList();
        });

        dom.addBtn.addEventListener('click', handleAdd);
        
        dom.inputName.addEventListener('input', (e) => {
            const val = e.target.value;
            
            if (state.enableSuggestions && val.length > 0) {
                const matches = state.products.filter(p => p.name.toLowerCase().startsWith(val.toLowerCase()));
                showSuggestions(matches);
            } else {
                hideSuggestions();
            }

            const product = state.products.find(p => p.name.toLowerCase() === val.toLowerCase());
            if (product) {
                dom.inputPrice.value = product.price;
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (dom.suggestionsDropdown && !dom.suggestionsDropdown.contains(e.target) && e.target !== dom.inputName) {
                hideSuggestions();
            }
        });

        dom.inputName.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAdd(e);
        });
        
        dom.inputPrice.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAdd(e);
        });

        dom.inputQuantity.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAdd(e);
        });

        // Share Button Listener
        const shareBtn = document.getElementById('share-btn');
        if (shareBtn) shareBtn.addEventListener('click', shareList);

        dom.toggleBtn.addEventListener('click', toggleShopMode);
        dom.themeBtn.addEventListener('click', toggleTheme);
        
        dom.cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        dom.confirmDeleteBtn.addEventListener('click', confirmDelete);
        dom.deleteModal.addEventListener('click', (e) => {
            if (e.target === dom.deleteModal) closeDeleteModal();
        });

        dom.cancelEditBtn.addEventListener('click', closeEditModal);
        dom.saveEditBtn.addEventListener('click', saveEdit);
        dom.editModal.addEventListener('click', (e) => {
            if (e.target === dom.editModal) closeEditModal();
        });
        // Edit Modal Enter Keys
        dom.editNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveEdit();
        });
        dom.editPriceInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveEdit();
        });
        dom.editCategorySelect.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveEdit();
        });

        dom.cancelCategoryBtn.addEventListener('click', closeAddCategoryModal);
        dom.confirmCategoryBtn.addEventListener('click', confirmAddCategory);
        dom.newCategoryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmAddCategory();
        });
        dom.addCategoryModal.addEventListener('click', (e) => {
            if (e.target === dom.addCategoryModal) closeAddCategoryModal();
        });

        dom.finishShopBtn.addEventListener('click', openFinishModal);
        dom.cancelFinishBtn.addEventListener('click', closeFinishModal);
        dom.confirmFinishBtn.addEventListener('click', confirmFinishShopping);
        dom.finishModal.addEventListener('click', (e) => {
            if (e.target === dom.finishModal) closeFinishModal();
        });

        dom.settingsBtn.addEventListener('click', openSettingsModal);
        dom.cancelSettingsBtn.addEventListener('click', closeSettingsModal);
        dom.saveSettingsBtn.addEventListener('click', saveSettings);
        dom.settingsRoundContainer.addEventListener('click', toggleSettingsRound);
        dom.settingsSuggestionsContainer.addEventListener('click', toggleSettingsSuggestions);
        dom.settingsConfirmBudgetContainer.addEventListener('click', () => toggleConfirm('budget'));
        dom.settingsConfirmItemContainer.addEventListener('click', () => toggleConfirm('item'));
        dom.settingsConfirmSuggestionContainer.addEventListener('click', () => toggleConfirm('suggestion'));
        dom.settingsConfirmFinishContainer.addEventListener('click', () => toggleConfirm('finish'));
        dom.settingsModal.addEventListener('click', (e) => {
            if (e.target === dom.settingsModal) closeSettingsModal();
        });

        // Tutorial Listeners
        dom.tutorialBtn.addEventListener('click', openTutorialModal);
        dom.closeTutorialBtn.addEventListener('click', closeTutorialModal);
        dom.okTutorialBtn.addEventListener('click', closeTutorialModal);
        dom.tutorialModal.addEventListener('click', (e) => {
            if (e.target === dom.tutorialModal) closeTutorialModal();
        });

        // Recipes Listeners
        if (dom.recipesBtn) dom.recipesBtn.addEventListener('click', openRecipesModal);
        if (dom.closeRecipesModalBtn) dom.closeRecipesModalBtn.addEventListener('click', closeRecipesModal);
        if (dom.recipesModal) dom.recipesModal.addEventListener('click', (e) => {
            if (e.target === dom.recipesModal) closeRecipesModal();
        });
        if (dom.openNewRecipeModalBtn) dom.openNewRecipeModalBtn.addEventListener('click', openNewRecipeModal);
        
        if (dom.cancelRecipeBtn) dom.cancelRecipeBtn.addEventListener('click', closeNewRecipeModal);
        if (dom.saveRecipeBtn) dom.saveRecipeBtn.addEventListener('click', saveRecipe);
        if (dom.addIngredientBtn) dom.addIngredientBtn.addEventListener('click', addRecipeIngredientRow);
        if (dom.newRecipeModal) dom.newRecipeModal.addEventListener('click', (e) => {
            if (e.target === dom.newRecipeModal) closeNewRecipeModal();
        });

        // Settings Modal Enter Key
        dom.settingsAppName.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveSettings();
        });

        // Delete Suggestion Listeners
        dom.cancelDeleteSuggestionBtn.addEventListener('click', closeDeleteSuggestionModal);
        dom.confirmDeleteSuggestionBtn.addEventListener('click', confirmDeleteSuggestion);
        dom.deleteSuggestionModal.addEventListener('click', (e) => {
            if (e.target === dom.deleteSuggestionModal) closeDeleteSuggestionModal();
        });

        // --- BUDGET SETTINGS LISTENERS ---
        const budgetSettingsModal = document.getElementById('budget-settings-modal');
        const budgetSettingsBtn = document.getElementById('budget-settings-btn');
        const closeBudgetSettingsBtn = document.getElementById('close-budget-settings-modal');
        const cancelBudgetSettingsBtn = document.getElementById('cancel-budget-settings');
        const saveBudgetSettingsBtn = document.getElementById('save-budget-settings');
        const budgetTitleInput = document.getElementById('budget-title-input');
        const budgetLimitInput = document.getElementById('budget-limit-input');

        function openBudgetSettings() {
            budgetTitleInput.value = state.budgetTitle;
            budgetLimitInput.value = state.budgetLimit;
            budgetSettingsModal.classList.remove('hidden');
            setTimeout(() => budgetSettingsModal.classList.remove('opacity-0'), 10);
        }

        function closeBudgetSettings() {
            budgetSettingsModal.classList.add('opacity-0');
            setTimeout(() => budgetSettingsModal.classList.add('hidden'), 300);
        }

        function saveBudgetSettings() {
            closeBudgetSettings();
            const newTitle = budgetTitleInput.value.trim() || 'Or√ßamento Semanal';
            const newLimit = parseFloat(budgetLimitInput.value) || 500;
            
            state.budgetTitle = newTitle;
            state.budgetLimit = newLimit;
            saveActiveBudgetMetadata();
            
            renderStats();
        }

        if (budgetSettingsBtn) budgetSettingsBtn.addEventListener('click', openBudgetSettings);
        if (closeBudgetSettingsBtn) closeBudgetSettingsBtn.addEventListener('click', closeBudgetSettings);
        if (cancelBudgetSettingsBtn) cancelBudgetSettingsBtn.addEventListener('click', closeBudgetSettings);
        if (saveBudgetSettingsBtn) saveBudgetSettingsBtn.addEventListener('click', saveBudgetSettings);
        if (budgetSettingsModal) {
            budgetSettingsModal.addEventListener('click', (e) => {
                if (e.target === budgetSettingsModal) closeBudgetSettings();
            });
        }
        // Budget Settings Enter Keys
        if (budgetTitleInput) {
            budgetTitleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveBudgetSettings();
            });
        }
        if (budgetLimitInput) {
            budgetLimitInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveBudgetSettings();
            });
        }

        // --- HUB LISTENERS ---
        if (dom.backToHubBtn) dom.backToHubBtn.addEventListener('click', openHub);
        if (dom.openNewBudgetModalBtn) dom.openNewBudgetModalBtn.addEventListener('click', openNewBudgetModal);
        if (dom.cancelNewBudgetBtn) dom.cancelNewBudgetBtn.addEventListener('click', closeNewBudgetModal);
        if (dom.createBudgetBtn) dom.createBudgetBtn.addEventListener('click', handleCreateBudget);
        if (dom.newBudgetModal) {
            dom.newBudgetModal.addEventListener('click', (e) => {
                if (e.target === dom.newBudgetModal) closeNewBudgetModal();
            });
        }
        if (dom.newBudgetName) {
            dom.newBudgetName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleCreateBudget();
            });
        }
        if (dom.newBudgetLimit) {
            dom.newBudgetLimit.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleCreateBudget();
            });
        }

        // Edit Hub Budget Listeners
        if (dom.cancelEditHubBudgetBtn) dom.cancelEditHubBudgetBtn.addEventListener('click', closeEditHubBudgetModal);
        if (dom.saveEditHubBudgetBtn) dom.saveEditHubBudgetBtn.addEventListener('click', handleSaveEditHubBudget);
        if (dom.editHubBudgetModal) {
            dom.editHubBudgetModal.addEventListener('click', (e) => {
                if (e.target === dom.editHubBudgetModal) closeEditHubBudgetModal();
            });
        }
        if (dom.editHubBudgetName) {
            dom.editHubBudgetName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSaveEditHubBudget();
            });
        }
        if (dom.editHubBudgetLimit) {
            dom.editHubBudgetLimit.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSaveEditHubBudget();
            });
        }

        // Delete Budget Listeners
        if (dom.cancelDeleteBudgetBtn) dom.cancelDeleteBudgetBtn.addEventListener('click', closeDeleteBudgetModal);
        if (dom.confirmDeleteBudgetBtn) dom.confirmDeleteBudgetBtn.addEventListener('click', confirmDeleteBudget);
        if (dom.deleteBudgetModal) {
            dom.deleteBudgetModal.addEventListener('click', (e) => {
                if (e.target === dom.deleteBudgetModal) closeDeleteBudgetModal();
            });
        }

        // --- RECIPES LOGIC ---
        let recipes = [];

        function loadRecipes() {
            const saved = localStorage.getItem('lions_recipes');
            if (saved) {
                try {
                    recipes = JSON.parse(saved);
                } catch (e) {
                    console.error("Erro ao carregar receitas", e);
                    recipes = [];
                }
            }
        }

        function saveRecipes() {
            localStorage.setItem('lions_recipes', JSON.stringify(recipes));
            renderRecipesList();
        }

        function openRecipesModal() {
            const isDark = state.theme === 'dark';
            
            // Update Modal Theme
            dom.recipesModalContent.className = isDark
                ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-gray-700 transition-colors duration-500 max-h-[80vh] flex flex-col'
                : 'bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[80vh] flex flex-col';
            
            dom.recipesModalTitle.className = isDark
                ? 'text-lg font-bold text-white transition-colors'
                : 'text-lg font-bold text-slate-800 transition-colors';

            renderRecipesList();
            dom.recipesModal.classList.remove('hidden');
        }

        function closeRecipesModal() {
            dom.recipesModal.classList.add('hidden');
        }

        function renderRecipesList() {
            const list = dom.recipesList;
            if (!list) return;
            list.innerHTML = '';

            if (recipes.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <i data-lucide="chef-hat" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhuma receita cadastrada.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            recipes.forEach((recipe, index) => {
                const card = document.createElement('div');
                const isDark = state.theme === 'dark';
                
                card.className = isDark
                    ? 'bg-gray-700 p-4 rounded-xl border border-gray-600 flex justify-between items-center group'
                    : 'bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center group';
                
                const ingredientsCount = recipe.ingredients ? recipe.ingredients.length : 0;
                
                card.innerHTML = `
                    <div>
                        <h4 class="font-bold ${isDark ? 'text-white' : 'text-slate-800'}">${recipe.name}</h4>
                        <p class="text-xs ${isDark ? 'text-gray-400' : 'text-slate-500'}">${ingredientsCount} ingredientes</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addRecipeToBudget(${index})" class="p-2 rounded-lg ${isDark ? 'bg-indigo-900 text-indigo-300 hover:bg-indigo-800' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'} transition-colors" title="Adicionar √† Lista">
                            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteRecipe(${index})" class="p-2 rounded-lg text-slate-400 hover:text-red-500 ${isDark ? 'hover:bg-gray-600' : 'hover:bg-slate-100'} transition-colors" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function openNewRecipeModal() {
            const isDark = state.theme === 'dark';
            
            // Update Modal Theme
            dom.newRecipeModalContent.className = isDark
                ? 'bg-gray-800 p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-gray-700 transition-colors duration-500 max-h-[90vh] overflow-y-auto'
                : 'bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 border border-slate-100 transition-colors duration-500 max-h-[90vh] overflow-y-auto';
            
            dom.newRecipeModalTitle.className = isDark
                ? 'text-lg font-bold text-white mb-4 transition-colors'
                : 'text-lg font-bold text-slate-800 mb-4 transition-colors';
            
            // Update Input Theme
            dom.recipeNameInput.className = isDark
                ? 'w-full h-10 px-4 bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg text-sm transition-all font-medium text-white placeholder-gray-400'
                : 'w-full h-10 px-4 bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm transition-all font-medium';

            dom.recipeNameInput.value = '';
            dom.recipeIngredientsList.innerHTML = '';
            addRecipeIngredientRow(); // Add first row
            addRecipeIngredientRow(); // Add second row
            dom.newRecipeModal.classList.remove('hidden');
        }

        function closeNewRecipeModal() {
            dom.newRecipeModal.classList.add('hidden');
        }

        function addRecipeIngredientRow() {
            const row = document.createElement('div');
            const isDark = state.theme === 'dark';
            row.className = 'flex gap-2 items-center';
            
            const inputClass = isDark
                ? 'bg-gray-700 border-transparent focus:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-lg text-sm transition-all text-white placeholder-gray-400'
                : 'bg-slate-50 border-transparent focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-lg text-sm transition-all';

            row.innerHTML = `
                <input type="text" placeholder="Ingrediente" class="flex-1 h-9 px-3 ${inputClass} recipe-ing-name">
                <input type="number" placeholder="Qtd" class="w-16 h-9 px-2 ${inputClass} recipe-ing-qty">
                <div class="relative w-20 h-9">
                    <select class="w-full h-full px-1 ${inputClass} recipe-ing-unit appearance-none text-center cursor-pointer">
                        <option value="un">un</option>
                        <option value="kg">kg</option>
                        <option value="g">g</option>
                        <option value="L">L</option>
                        <option value="ml">ml</option>
                        <option value="cx">cx</option>
                        <option value="pct">pct</option>
                    </select>
                    <div class="absolute inset-y-0 right-1 flex items-center pointer-events-none text-slate-400">
                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            dom.recipeIngredientsList.appendChild(row);
            lucide.createIcons();
        }

        function saveRecipe() {
            const name = dom.recipeNameInput.value.trim();
            if (!name) {
                alert('Digite o nome da receita.');
                return;
            }

            const ingredients = [];
            const rows = dom.recipeIngredientsList.querySelectorAll('div');
            rows.forEach(row => {
                const ingName = row.querySelector('.recipe-ing-name').value.trim();
                const ingQty = parseFloat(row.querySelector('.recipe-ing-qty').value) || 1;
                const ingUnit = row.querySelector('.recipe-ing-unit').value;

                if (ingName) {
                    ingredients.push({ name: ingName, quantity: ingQty, unit: ingUnit });
                }
            });

            if (ingredients.length === 0) {
                alert('Adicione pelo menos um ingrediente.');
                return;
            }

            recipes.push({ name, ingredients });
            saveRecipes();
            closeNewRecipeModal();
            renderRecipesList();
        }

        function deleteRecipe(index) {
            if (confirm('Excluir esta receita?')) {
                recipes.splice(index, 1);
                saveRecipes();
            }
        }

        async function addRecipeToBudget(index) {
            if (!state.activeBudgetId) {
                alert('Abra um or√ßamento primeiro para adicionar os ingredientes.');
                closeRecipesModal();
                return;
            }

            const recipe = recipes[index];
            if (!recipe) return;

            if (confirm(`Adicionar todos os ingredientes de "${recipe.name}" √† lista atual?`)) {
                closeRecipesModal();
                
                // Add items sequentially
                for (const ing of recipe.ingredients) {
                    const newItem = {
                        name: ing.name,
                        category: 'Geral', // Default category
                        quantity: ing.quantity,
                        unit: ing.unit,
                        price: 0,
                        checked: false
                    };
                    
                    // Optimistic UI update
                    state.items.push(newItem);
                    
                    // API Call (background)
                    apiService.addItem(newItem).then(savedItem => {
                        // Update with real ID if needed
                    });
                }
                
                renderAll();
                alert(`${recipe.ingredients.length} ingredientes adicionados!`);
            }
        }

        // --- THEME LOGIC ---
        function setTheme(themeName) {
            const root = document.documentElement;
            
            // Remove all theme classes
            root.classList.remove('theme-emerald', 'theme-rose', 'theme-amber');
            
            // Add new theme class if not default (indigo)
            if (themeName !== 'indigo') {
                root.classList.add(`theme-${themeName}`);
            }
            
            // Save preference
            localStorage.setItem('lions_theme_color', themeName);
            
            // Close settings modal
            closeSettingsModal();
        }

        // Load saved theme on init
        const savedThemeColor = localStorage.getItem('lions_theme_color');
        if (savedThemeColor) {
            setTheme(savedThemeColor);
        }

        // --- WHATSAPP SHARE ---
        function shareList() {
            let text = `*Lista de Compras: ${state.budgetTitle}*\n\n`;
            const items = state.items;
            const pending = items.filter(i => !i.checked);
            const done = items.filter(i => i.checked);

            if (pending.length > 0) {
                text += "*A Comprar:*\n";
                pending.forEach(item => {
                    text += `‚¨ú ${item.quantity}${item.unit || 'un'} ${item.name}\n`;
                });
                text += "\n";
            }

            if (done.length > 0) {
                text += "*Carrinho:*\n";
                done.forEach(item => {
                    text += `‚úÖ ${item.quantity}${item.unit || 'un'} ${item.name}\n`;
                });
            }
            
            const total = state.items.reduce((acc, curr) => acc + (curr.price * (curr.quantity || 1)), 0);
            text += `\nTotal Estimado: R$ ${total.toFixed(2)}`;

            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- OFFLINE SUPPORT ---
        window.addEventListener('online', async () => {
            console.log("Online");
            const overlay = document.getElementById('loading-overlay');
            if(overlay) overlay.classList.add('hidden');
            
            const offlineWarning = document.getElementById('offline-warning');
            if(offlineWarning) offlineWarning.classList.add('hidden');
            
            // Reload data from API
            try {
                const budgets = await apiService.fetchBudgets();
                state.budgets = budgets;
                state.products = await apiService.fetchProducts();
                renderAll();
            } catch (e) {
                console.error("Erro ao recarregar dados ap√≥s reconex√£o:", e);
            }
        });
        
        window.addEventListener('offline', () => {
            console.log("Offline");
            const offlineWarning = document.getElementById('offline-warning');
            if(offlineWarning) offlineWarning.classList.remove('hidden');
        });

        // --- INICIALIZA√á√ÉO ---
        init();

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

    </script>
</body>
</html>